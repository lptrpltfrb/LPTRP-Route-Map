<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LTFRB Route Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { margin:0; padding:0; }
    #map { width:1170px; height:800px; }

    /* Filter box */
    .filter-box {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      width: 250px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      z-index: 1000;
    }
    .route-list {
      max-height: 150px;
      overflow-y: auto;
      margin-top: 8px;
      border-top: 1px solid #ccc;
      padding-top: 6px;
    }
    .route-item {
      cursor: pointer;
      padding: 3px;
      border-radius: 4px;
    }
    .route-item:hover {
      background: #f0f0f0;
    }
    .hover-info {
      margin-top: 6px;
      font-size: 12px;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="filter-box">
    <b>Route Info</b>
    <div class="hover-info">Hover count: 0</div>
    <div class="route-list"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const map = L.map('map').setView([12.8797, 121.7740], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const hoverInfo = document.querySelector('.hover-info');
    const routeList = document.querySelector('.route-list');

    let routes = [];

    // Fetch CSV
    Papa.parse("YOUR_CSV_URL_HERE", {
      download: true,
      header: true,
      complete: function(results) {
        results.data.forEach(row => {
          if (!row["GEO PATH"]) return;
          try {
            const coords = JSON.parse(row["GEO PATH"]);
            const color = '#'+Math.floor(Math.random()*16777215).toString(16);

            const polyline = L.polyline(coords, { color: color, weight: 3 }).addTo(map);

            polyline.routeData = {
              "Route Name": row["ROUTE NAME"] || "N/A",
              "DENO": row["DENO"] || "N/A",
              "Class": row["Class"] || "N/A",
              "Route Class": row["ROUTE CLASSIFICATION (if LPTRP)"] || "N/A",
              "NAU": row["NO. OF AUTHORIZED UNITS"] || "N/A"
            };

            routes.push(polyline);
          } catch (e) {
            console.warn("Invalid GEO PATH", row["GEO PATH"]);
          }
        });
      }
    });

    // Hover & Click events on map
    map.on("mousemove", function(e) {
      let count = 0;
      routes.forEach(r => {
        if (L.GeometryUtil.isPointOnLine(map, e.latlng, r)) {
          count++;
          r.setStyle({ weight: 5 });
        } else {
          r.setStyle({ weight: 3 });
        }
      });
      hoverInfo.textContent = "Hover count: " + count;
    });

    map.on("click", function(e) {
      routeList.innerHTML = "";
      let overlapping = routes.filter(r => L.GeometryUtil.isPointOnLine(map, e.latlng, r));

      overlapping.forEach(r => {
        const div = document.createElement("div");
        div.className = "route-item";
        div.textContent = r.routeData["Route Name"];
        div.onclick = () => {
          routes.forEach(rt => rt.setStyle({ color: "#999", weight: 2 }));
          r.setStyle({ color: "red", weight: 6 });

          alert(
            "Route Name: " + r.routeData["Route Name"] + "\n" +
            "DENO: " + r.routeData["DENO"] + "\n" +
            "Class: " + r.routeData["Class"] + "\n" +
            "Route Class: " + r.routeData["Route Class"] + "\n" +
            "NAU: " + r.routeData["NAU"]
          );
        };
        routeList.appendChild(div);
      });
    });

  </script>
  <script src="https://unpkg.com/leaflet-geometryutil"></script>
</body>
</html>
