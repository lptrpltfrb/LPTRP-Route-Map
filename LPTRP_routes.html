<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Route Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    #map { width: 1170px; height: 800px; }
    .popup-container {
      display: flex;
      flex-direction: row;
      gap: 15px;
      min-width: 400px;
      font-family: Arial, sans-serif;
      font-size: 13px;
    }
    .route-list {
      width: 160px;
      max-height: 200px;
      overflow-y: auto;
      border-right: 1px solid #ccc;
      padding-right: 10px;
    }
    .route-list div {
      cursor: pointer;
      margin-bottom: 5px;
      padding: 2px;
    }
    .route-list div:hover {
      background-color: #f0f0f0;
    }
    .route-details {
      flex: 1;
      padding-left: 10px;
    }
    .hover-label {
      background: white;
      padding: 2px 6px;
      border: 1px solid #666;
      border-radius: 4px;
      font-size: 12px;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRyCBsc0sCJs7FXH1Q1XEiCuMrV_ckVg9tcMvozYThFJfqpcOPdlo6YqxBYf6I1zHO0-yQZ_vz3knSS/pub?gid=1233383270&single=true&output=csv";

    const map = L.map('map').setView([12.8797, 121.7740], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let allRoutes = [];
    let hoverLabel = L.tooltip({ permanent: false, className: 'hover-label' });

    // Parse CSV
    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: function(results) {
        results.data.forEach(row => {
          if (row["GEO PATH"]) {
            try {
              let coords = JSON.parse(row["GEO PATH"]);
              let polyline = L.polyline(coords, {
                color: getRandomColor(),
                weight: 3
              }).addTo(map);
              polyline.routeData = row;
              allRoutes.push(polyline);

              // Hover: show count of overlapping routes
              polyline.on('mouseover', function(e) {
                let overlapping = findOverlappingRoutes(e.latlng);
                hoverLabel.setContent(overlapping.length + " routes here");
                hoverLabel.setLatLng(e.latlng);
                hoverLabel.addTo(map);
              });
              polyline.on('mouseout', function() {
                map.removeLayer(hoverLabel);
              });

              // Click: show popup with list + details
              polyline.on('click', function(e) {
                let overlapping = findOverlappingRoutes(e.latlng);
                showPopup(e.latlng, overlapping);
              });
            } catch(e) {
              console.log("Invalid GEO PATH for row", row);
            }
          }
        });
      }
    });

    function getRandomColor() {
      return "#" + Math.floor(Math.random()*16777215).toString(16);
    }

    function findOverlappingRoutes(latlng) {
      return allRoutes.filter(r => {
        return leafletPip.pointInLayer([latlng.lng, latlng.lat], r).length > 0 ||
               r.getBounds().contains(latlng);
      });
    }

    function showPopup(latlng, overlapping) {
      let listHtml = "<div class='route-list'>";
      overlapping.forEach((r, i) => {
        listHtml += `<div onclick="showRouteDetails(${i})">${r.routeData['ROUTE NAME'] || 'Unnamed Route'}</div>`;
      });
      listHtml += "</div>";

      let detailsHtml = "<div class='route-details' id='route-details'>Click a route to see details</div>";

      let popupContent = `<div class="popup-container">${listHtml}${detailsHtml}</div>`;
      let popup = L.popup()
        .setLatLng(latlng)
        .setContent(popupContent)
        .openOn(map);

      // store overlapping globally so details can be updated
      window.currentOverlapping = overlapping;
    }

    window.showRouteDetails = function(index) {
      let r = window.currentOverlapping[index];
      let html = `
        <b>${r.routeData['ROUTE NAME'] || 'Unnamed Route'}</b><br/>
        DENO: ${r.routeData['DENO'] || ''}<br/>
        Class: ${r.routeData['Class'] || ''}<br/>
        Route Class: ${r.routeData['ROUTE CLASSIFICATION (if LPTRP)'] || ''}<br/>
        NAU: ${r.routeData['NO. OF AUTHORIZED UNITS'] || ''}
      `;
      document.getElementById("route-details").innerHTML = html;
      highlightRoute(r);
    };

    function highlightRoute(route) {
      allRoutes.forEach(r => r.setStyle({ weight: 3 }));
      route.setStyle({ weight: 6, color: "red" });
    }

    // Close popup when clicking map
    map.on('click', function(e) {
      map.closePopup();
    });

    // Fallback if leaflet-pip is missing (simple bounds check)
    function leafletPip() {}
    leafletPip.pointInLayer = function(point, layer) { return []; }
  </script>
</body>
</html>
