<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>LTFRB LPTRP Route Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    .info { background: white; padding: 6px 8px; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([12.8797, 121.774], 6); // Centered on Philippines

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRyCBsc0sCJs7FXH1Q1XEiCuMrV_ckVg9tcMvozYThFJfqpcOPdlo6YqxBYf6I1zHO0-yQZ_vz3knSS/pub?gid=1233383270&single=true&output=csv';

    async function loadRoutes() {
      try {
        const response = await fetch(csvUrl);
        const csv = await response.text();
        parseCSV(csv);
      } catch (error) {
        console.error("‚ùå Failed to load CSV:", error);
      }
    }

    function parseCSV(data) {
      const lines = data.trim().split('\n');
      const headers = lines[1].split(','); // Row 2 = headers
      const rows = lines.slice(2);         // Row 3+ = data

      let valid = 0;
      let emptyRows = 0;
      let invalidRows = 0;

      rows.forEach((row, i) => {
        const cols = row.split(',');

        const geoPathRaw = cols[25]?.trim(); // Column Z = index 25

        if (!geoPathRaw) {
          emptyRows++;
          return;
        }

        try {
          const coords = JSON.parse(geoPathRaw);
          if (!Array.isArray(coords) || coords.length === 0) throw new Error();

          const latLngs = coords.map(([lng, lat]) => [lat, lng]);
          L.polyline(latLngs, { color: 'blue', weight: 3 }).addTo(map);
          valid++;
        } catch {
          invalidRows++;
        }
      });

      console.log(`üìä Rows processed: ${rows.length}`);
      console.log(`üü¢ Valid geo paths: ${valid}`);
      console.log(`‚ö†Ô∏è Skipped empty GEO PATH rows: ${emptyRows}`);
      console.log(`‚ö†Ô∏è Skipped invalid GEO PATH rows: ${invalidRows}`);

      if (valid === 0) {
        console.warn("üö´ No valid routes found.");
      }
    }

    loadRoutes();
  </script>
</body>
</html>
