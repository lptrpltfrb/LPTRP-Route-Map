<!DOCTYPE html>
<html>
<head>
  <title>LPTRP Route Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      z-index: 1000;
      width: 300px;
    }
    .controls input, .controls select {
      width: 100%;
      margin: 5px 0;
      padding: 5px;
    }
  </style>
</head>
<body>
<div id="map"></div>
<div class="controls">
  <input type="text" id="searchRoute" placeholder="Search by Route Name" />
  <select id="pointAType">
    <option value="">Point A - Select type</option>
    <option value="ENDPOINT 1 REGION">Region</option>
    <option value="ENDPOINT 1 PROVINCE">Province</option>
    <option value="ENDPOINT 1 LGU">LGU</option>
    <option value="ENDPOINT 1 BARANGAY">Barangay</option>
    <option value="ENDPOINT 1 TERMINAL">Terminal</option>
  </select>
  <input type="text" id="pointAValue" placeholder="Enter Point A value" />

  <select id="pointBType">
    <option value="">Point B - Select type</option>
    <option value="ENDPOINT 2 REGION">Region</option>
    <option value="ENDPOINT 2 PROVINCE">Province</option>
    <option value="ENDPOINT 2 LGU">LGU</option>
    <option value="ENDPOINT 2 BARANGAY">Barangay</option>
    <option value="ENDPOINT 2 TERMINAL">Terminal</option>
  </select>
  <input type="text" id="pointBValue" placeholder="Enter Point B value" />

  <select id="viaType">
    <option value="">Via - Select type</option>
    <option value="ROUTE STRUCTURE">Road</option>
    <option value="CORRIDOR">LGU</option>
  </select>
  <input type="text" id="viaValue" placeholder="Enter via value" />

  <button onclick="applyFilters()">Apply Filters</button>
  <button onclick="resetFilters()">Reset</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<script>
const map = L.map('map').setView([13, 122], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: 'Â© OpenStreetMap'
}).addTo(map);
L.control.scale().addTo(map);

const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRyCBsc0sCJs7FXH1Q1XEiCuMrV_ckVg9tcMvozYThFJfqpcOPdlo6YqxBYf6I1zHO0-yQZ_vz3knSS/pub?gid=1233383270&single=true&output=csv";
const routeLayers = [];
let routeData = [];

function resetMap() {
  routeLayers.forEach(layer => map.removeLayer(layer));
  routeLayers.length = 0;
}

function applyFilters() {
  const routeSearch = document.getElementById('searchRoute').value.trim().toLowerCase();
  const pointACol = document.getElementById('pointAType').value;
  const pointAVal = document.getElementById('pointAValue').value.trim().toLowerCase();
  const pointBCol = document.getElementById('pointBType').value;
  const pointBVal = document.getElementById('pointBValue').value.trim().toLowerCase();
  const viaCol = document.getElementById('viaType').value;
  const viaVal = document.getElementById('viaValue').value.trim().toLowerCase();

  resetMap();

  routeData.forEach(row => {
    const name = (row["ROUTE NAME"] || "").toLowerCase();
    const geo = row["GEO PATH"];
    if (!geo || geo.trim() === "") return;

    if (routeSearch && !name.includes(routeSearch)) return;
    if (pointACol && pointAVal && (row[pointACol] || "").toLowerCase() !== pointAVal) return;
    if (pointBCol && pointBVal && (row[pointBCol] || "").toLowerCase() !== pointBVal) return;
    if (viaCol && viaVal && (row[viaCol] || "").toLowerCase() !== viaVal) return;

    try {
      const coords = JSON.parse(geo).map(p => [p[1], p[0]]);
      const poly = L.polyline(coords, {
        color: getRandomColor(),
        weight: 4
      }).addTo(map);

      poly.bindPopup(
        `<b>${row["ROUTE NAME"] || "Unnamed"}</b><br>` +
        `DENO: ${row["DENO"] || ""}<br>` +
        `NAU: ${row["NO. OF AUTHORIZED UNITS"] || ""}<br>` +
        `CLASSIFICATION: ${row["ROUTE CLASSIFICATION (if LPTRP)"] || ""}`
      );

      routeLayers.push(poly);
    } catch (e) {
      console.warn("Invalid GEO PATH JSON", e);
    }
  });
}

function resetFilters() {
  document.getElementById('searchRoute').value = "";
  document.getElementById('pointAType').value = "";
  document.getElementById('pointAValue').value = "";
  document.getElementById('pointBType').value = "";
  document.getElementById('pointBValue').value = "";
  document.getElementById('viaType').value = "";
  document.getElementById('viaValue').value = "";
  applyFilters();
}

function getRandomColor() {
  const letters = '0123456789ABCDEF';
  let color = '#';
  for (let i = 0; i < 6; i++) {
    color += letters[Math.floor(Math.random() * 16)];
  }
  return color;
}

async function loadCSV() {
  const response = await fetch(csvUrl);
  const text = await response.text();

  Papa.parse(text, {
    header: true,
    skipEmptyLines: true,
    complete: function(res) {
      routeData = res.data;
      applyFilters();
    }
  });
}

loadCSV();
</script>
</body>
</html>
