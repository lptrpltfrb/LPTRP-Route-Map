<!DOCTYPE html>
<html>
<head>
  <title>LPTRP Routes Viewer</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    #map { height: 100vh; width: 100%; }
    .filter-bar {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <div class="filter-bar">
    <label for="modeFilter">Mode:</label>
    <select id="modeFilter">
      <option value="">All</option>
    </select>

    <label for="locationType">Filter:</label>
    <select id="locationType">
      <option value="DESTINATION">Destination</option>
      <option value="ORIGIN">Origin</option>
    </select>

    <label for="locationValue">Province:</label>
    <select id="locationValue">
      <option value="">All</option>
    </select>
  </div>
  <div id="map"></div>

  <script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRyCBsc0sCJs7FXH1Q1XEiCuMrV_ckVg9tcMvozYThFJfqpcOPdlo6YqxBYf6I1zHO0-yQZ_vz3knSS/pub?gid=1233383270&single=true&output=csv';

    const map = L.map('map').setView([12.8797, 121.774], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data © OpenStreetMap contributors'
    }).addTo(map);

    let allData = [];
    let allRoutes = [];

    function parseCSV(text) {
      const rows = text.trim().split('\n').map(r => r.split(','));
      const headers = rows[1];
      const dataRows = rows.slice(2);
      return dataRows.map(row => {
        const obj = {};
        headers.forEach((h, i) => obj[h.trim()] = row[i]);
        return obj;
      });
    }

    function renderRoutes() {
      allRoutes.forEach(route => map.removeLayer(route));
      allRoutes = [];

      const selectedMode = document.getElementById('modeFilter').value;
      const locationType = document.getElementById('locationType').value;
      const locationValue = document.getElementById('locationValue').value;

      allData.forEach(row => {
        if (selectedMode && row['MODE'] !== selectedMode) return;
        if (locationValue && row[`${locationType} PROVINCE`] !== locationValue) return;

        let pathStr = row['GEO PATH'];
        if (!pathStr || pathStr.trim() === '') {
          console.warn('⚠️ Invalid GEO PATH:', pathStr);
          return;
        }

        try {
          const coords = JSON.parse(pathStr);
          const polyline = L.polyline(coords, { color: 'blue' }).addTo(map);
          allRoutes.push(polyline);
        } catch (e) {
          console.warn('⚠️ Invalid GEO PATH:', pathStr);
        }
      });
    }

    function populateFilters() {
      const modeSet = new Set();
      const provinceSet = new Set();
      allData.forEach(row => {
        if (row['MODE']) modeSet.add(row['MODE']);
        if (row['DESTINATION PROVINCE']) provinceSet.add(row['DESTINATION PROVINCE']);
        if (row['ORIGIN PROVINCE']) provinceSet.add(row['ORIGIN PROVINCE']);
      });

      const modeSelect = document.getElementById('modeFilter');
      modeSet.forEach(mode => {
        const opt = document.createElement('option');
        opt.value = opt.textContent = mode;
        modeSelect.appendChild(opt);
      });

      const provinceSelect = document.getElementById('locationValue');
      provinceSet.forEach(prov => {
        const opt = document.createElement('option');
        opt.value = opt.textContent = prov;
        provinceSelect.appendChild(opt);
      });
    }

    fetch(csvUrl)
      .then(response => response.text())
      .then(text => {
        allData = parseCSV(text);
        populateFilters();
        renderRoutes();
      });

    document.getElementById('modeFilter').addEventListener('change', renderRoutes);
    document.getElementById('locationType').addEventListener('change', renderRoutes);
    document.getElementById('locationValue').addEventListener('change', renderRoutes);
  </script>
</body>
</html>
