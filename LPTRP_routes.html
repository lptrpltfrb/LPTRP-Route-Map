fetch(sheetURL)
  .then(res => res.text())
  .then(csvText => {
    console.log("First 200 chars of CSV:", csvText.slice(0, 200));
    const rows = csvText.split("\n");
    console.log("Total rows:", rows.length);
    const headers = rows[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
    console.log("Headers:", headers);
    const routeNameIndex = 9; // Route Name column
    const geoPathIndex = 26; // GEO PATH column

    rows.slice(1).forEach((row, i) => {
      const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
      const rn = cols[routeNameIndex]?.trim();
      const gp = cols[geoPathIndex]?.trim();
      console.log(`Row ${i+2} name:`, rn, "GeoPath starts with [[?", gp?.startsWith("[["));
      try {
        if (gp && gp.startsWith('[[')) {
          const coords = JSON.parse(gp);
          console.log(`Parsed ${coords.length} coords for ${rn}`);
          const latlngs = coords.map(c => [c[1], c[0]]);
          const pl = L.polyline(latlngs, { color: 'red' }).addTo(map);
          pl.bindPopup(rn || "Unnamed");
        }
      } catch (e) {
        console.error("Parse error at row", i+2, rn, e, gp);
      }
    });
  });
