<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>LPTRP Route Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css"/>
<style>
html,body{height:100%;margin:0;padding:0;background:#f5f6f7;}
#map{width:1170px;height:800px;margin:10px auto;box-shadow:0 2px 6px rgba(0,0,0,.15);}
.filter-box{
  position:absolute;top:10px;left:10px;width:340px;background:#fff;padding:10px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.15);z-index:2000;overflow:auto;max-height:780px;font-family:Arial, Helvetica, sans-serif;font-size:13px;
}
.filter-box h4{margin:4px 0;font-size:14px;}
.filter-box label{font-size:12px;margin-top:6px;display:block;}
.filter-box input{width:100%;padding:4px 6px;margin-bottom:4px;border:1px solid #ccc;border-radius:4px;font-size:12px;box-sizing:border-box;}
.filter-box button{width:100%;padding:6px;margin-top:6px;border:none;border-radius:4px;background:#2f78a0;color:#fff;cursor:pointer;font-size:13px;}
.route-list-popup{max-height:200px;overflow:auto;}
.route-list-popup div{padding:4px 6px;cursor:pointer;border-bottom:1px solid #ddd;}
.route-list-popup div:hover{background:#f0f8ff;}
</style>
</head>
<body>
<div id="map"></div>
<div class="filter-box">
<h4>Search by Route Name</h4>
<input id="routeName" placeholder="Type route name..."/>
<h4>Search by Endpoints</h4>
<label>End Point 1 Region</label><input id="ep1Region" placeholder="Type region..."/>
<label>End Point 1 Province</label><input id="ep1Province" placeholder="Type province..."/>
<label>End Point 1 LGU</label><input id="ep1LGU" placeholder="Type LGU..."/>
<label>End Point 1 Barangay</label><input id="ep1Barangay" placeholder="Type barangay..."/>
<label>End Point 1 Terminal</label><input id="ep1Terminal" placeholder="Type terminal..."/>
<label>End Point 2 Region</label><input id="ep2Region" placeholder="Type region..."/>
<label>End Point 2 Province</label><input id="ep2Province" placeholder="Type province..."/>
<label>End Point 2 LGU</label><input id="ep2LGU" placeholder="Type LGU..."/>
<label>End Point 2 Barangay</label><input id="ep2Barangay" placeholder="Type barangay..."/>
<label>End Point 2 Terminal</label><input id="ep2Terminal" placeholder="Type terminal..."/>
<button id="applyFilter">Apply Filter</button>
<button id="clearFilter">Clear Filter</button>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
$(document).ready(function(){
  const map = L.map('map').setView([13,122],6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18, attribution:'Â© OpenStreetMap'}).addTo(map);
  L.control.scale({position:'bottomleft',metric:true}).addTo(map);

  const csvUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vRyCBsc0sCJs7FXH1Q1XEiCuMrV_ckVg9tcMvozYThFJfqpcOPdlo6YqxBYf6I1zHO0-yQZ_vz3knSS/pub?gid=1233383270&single=true&output=csv";

  let allData=[], routeLayers=[], hoverPopup=null, routeDetailPopup=null, clickedRouteLayer=null;

  function normalize(s){return s?s.toString().trim():"";}

  function drawRoute(row){
    if(!row["GEO PATH"]) return;
    let coords;
    try{coords=JSON.parse(row["GEO PATH"]);}catch(e){return;}
    if(!Array.isArray(coords[0][0])) coords=[coords];
    const routeName=normalize(row["ROUTE NAME"]);
    const color='#'+Math.floor(Math.random()*16777215).toString(16);
    coords.forEach(seg=>{
      const latlngs=seg.map(c=>[+c[1],+c[0]]);
      const pl=L.polyline(latlngs,{color:color,weight:4,opacity:0.95}).addTo(map);
      pl.options.routeName=routeName;
      pl.options.rowData=row;

      pl.on('mouseover',function(e){
        this.setStyle({color:'yellow',weight:6,opacity:1});
        const overlapping = routeLayers.filter(r=>r.getBounds().contains(e.latlng));
        if(!hoverPopup) hoverPopup=L.popup({closeOnClick:false,autoClose:false}).setLatLng(e.latlng).setContent(`${overlapping.length} route(s)`).openOn(map);
        else hoverPopup.setLatLng(e.latlng).setContent(`${overlapping.length} route(s)`);
      });

      pl.on('mouseout',function(e){
        if(this!==clickedRouteLayer) this.setStyle({color:color,weight:4,opacity:0.95});
        if(hoverPopup) map.closePopup(hoverPopup);
      });

      pl.on('click',function(e){
        const overlapping = routeLayers.filter(r=>r.getBounds().contains(e.latlng));
        let html=`<div class="route-list-popup">`;
        overlapping.forEach(r=>{html+=`<div data-name="${r.options.routeName}">${r.options.routeName}</div>`;});
        html+="</div>";
        if(routeDetailPopup) map.closePopup(routeDetailPopup);
        routeDetailPopup=L.popup({closeOnClick:false,autoClose:false}).setLatLng(e.latlng).setContent(html).openOn(map);

        $(".route-list-popup div").click(function(ev){
          const rName=$(this).data('name');
          const selectedLayer=routeLayers.find(l=>l.options.routeName===rName);
          if(clickedRouteLayer && clickedRouteLayer!==selectedLayer){
            clickedRouteLayer.setStyle({color:clickedRouteLayer.options.color,weight:4,opacity:0.95});
          }
          clickedRouteLayer=selectedLayer;
          clickedRouteLayer.setStyle({color:'red',weight:6,opacity:1});
          const row=clickedRouteLayer.options.rowData;
          const info=`<div style="font-weight:bold">${row["ROUTE NAME"]}</div>
            <div>DENO: ${row["DENO"]}</div>
            <div>CLASS: ${row["Class"]}</div>
            <div>ROUTE CLASS: ${row["ROUTE CLASSIFICATION (if LPTRP)"]}</div>
            <div>NAU: ${row["NO. OF AUTHORIZED UNITS"]}</div>
            <div>ROUTE LENGTH: ${row["ROUTE LENGTH"]}</div>`;
          if(routeDetailPopup) routeDetailPopup.setContent(html+info);
        });
      });

      routeLayers.push(pl);
    });
  }

  Papa.parse(csvUrl,{download:true,header:true,complete:function(results){
    allData=results.data;
    allData.forEach(drawRoute);

    function combineColumns(c1,c2){return [...new Set(allData.map(r=>normalize(r[c1])).filter(Boolean).concat(allData.map(r=>normalize(r[c2])).filter(Boolean)))];}

    // Autocomplete
    $("#routeName").autocomplete({source:[...new Set(allData.map(r=>normalize(r["ROUTE NAME"])).filter(Boolean))]});
    $("#ep1Region").autocomplete({source:combineColumns("ENDPOINT 1 REGION","ENDPOINT 2 REGION")});
    $("#ep1Province").autocomplete({source:combineColumns("ENDPOINT 1 PROVINCE","ENDPOINT 2 PROVINCE")});
    $("#ep1LGU").autocomplete({source:combineColumns("ENDPOINT 1 LGU","ENDPOINT 2 LGU")});
    $("#ep1Barangay").autocomplete({source:combineColumns("ENDPOINT 1 BARANGAY","ENDPOINT 2 BARANGAY")});
    $("#ep1Terminal").autocomplete({source:combineColumns("ENDPOINT 1 TERMINAL","ENDPOINT 2 TERMINAL")});
    $("#ep2Region").autocomplete({source:combineColumns("ENDPOINT 1 REGION","ENDPOINT 2 REGION")});
    $("#ep2Province").autocomplete({source:combineColumns("ENDPOINT 1 PROVINCE","ENDPOINT 2 PROVINCE")});
    $("#ep2LGU").autocomplete({source:combineColumns("ENDPOINT 1 LGU","ENDPOINT 2 LGU")});
    $("#ep2Barangay").autocomplete({source:combineColumns("ENDPOINT 1 BARANGAY","ENDPOINT 2 BARANGAY")});
    $("#ep2Terminal").autocomplete({source:combineColumns("ENDPOINT 1 TERMINAL","ENDPOINT 2 TERMINAL")});
  }});

  map.on('click',function(){
    if(routeDetailPopup) map.closePopup(routeDetailPopup);
    if(hoverPopup) map.closePopup(hoverPopup);
    if(clickedRouteLayer){
      clickedRouteLayer.setStyle({color:clickedRouteLayer.options.color,weight:4,opacity:0.95});
      clickedRouteLayer=null;
    }
  });
});
</script>
</body>
</html>
