<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>LTFRB Routes Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body { margin:0; padding:0; }
    #map { width:1170px; height:800px; }

    .filter-box {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      max-width: 300px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      font-family: Arial, sans-serif;
    }
    .filter-box input {
      width: 100%;
      margin-bottom: 6px;
      padding: 4px;
    }

    .route-list-popup {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 1200;
      background: white;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      max-height: 200px;
      overflow-y: auto;
      font-family: Arial, sans-serif;
      font-size: 14px;
    }
    .route-list-popup div {
      cursor: pointer;
      padding: 3px 0;
    }
    .route-list-popup div:hover {
      background: #f0f0f0;
    }

    .details-popup {
      background: rgba(255,255,255,0.85);
      padding: 8px;
      border-radius: 6px;
      font-size: 13px;
      line-height: 1.4;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="filter-box">
    <div><strong>Search by Route Name</strong></div>
    <input type="text" id="routeNameInput" placeholder="Type route name..."/>
    <div><strong>Search by Endpoints</strong></div>
    <input type="text" id="ep1TerminalInput" placeholder="Endpoint 1 Terminal..."/>
    <input type="text" id="ep2TerminalInput" placeholder="Endpoint 2 Terminal..."/>
  </div>
  <div id="routeListPopup" class="route-list-popup" style="display:none"></div>

  <script>
    const sheetUrlMaster = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRyCBsc0sCJs7FXH1Q1XEiCuMrV_ckVg9tcMvozYThFJfqpcOPdlo6YqxBYf6I1zHO0-yQZ_vz3knSS/pub?gid=1233383270&single=true&output=csv";
    const sheetUrlTerminal = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRyCBsc0sCJs7FXH1Q1XEiCuMrV_ckVg9tcMvozYThFJfqpcOPdlo6YqxBYf6I1zHO0-yQZ_vz3knSS/pub?gid=1448318988&single=true&output=csv";

    const map = L.map('map').setView([12.8797, 121.7740], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let routes = [];
    let terminals = [];
    let routeLayers = [];
    let terminalMarkers = [];
    let highlighted = null;
    let listPopup = document.getElementById("routeListPopup");

    function normalize(str){ return (str||"").toString().trim(); }

    function addRoute(row){
      if(!row["GEO PATH"]) return;
      try{
        const coords = JSON.parse(row["GEO PATH"]);
        const poly = L.polyline(coords, {color: randomColor(), weight:3, opacity:0.7}).addTo(map);
        poly.routeData = row;
        routeLayers.push(poly);

        poly.on("mouseover", e=>{
          poly.setStyle({weight:5, opacity:1});
          const overlaps = routeLayers.filter(r=> isPointOnLine(e.latlng, r));
          const count = new Set(overlaps.map(r=>normalize(r.routeData["ROUTE NAME"]))).size;
          L.popup()
            .setLatLng(e.latlng)
            .setContent(count+" routes here")
            .openOn(map);
        });
        poly.on("mouseout", ()=>{
          if(highlighted !== poly) poly.setStyle({weight:3, opacity:0.7});
          map.closePopup();
        });
        poly.on("click", e=>{
          const overlaps = routeLayers.filter(r=> isPointOnLine(e.latlng, r));
          showRouteList(overlaps, e.latlng);
        });
      }catch(err){ console.error("Invalid GEO PATH", err); }
    }

    function addTerminal(row){
      if(!row["LATITUDE"] || !row["LONGITUDE"]) return;
      const lat = parseFloat(row["LATITUDE"]);
      const lng = parseFloat(row["LONGITUDE"]);
      if(isNaN(lat)||isNaN(lng)) return;

      const abbrev = getTypeAbbrev(normalize(row["TYPE"]));
      const marker = L.circleMarker([lat,lng],{
        radius:6, color:"black", fillColor:"orange", fillOpacity:0.9
      }).addTo(map);

      marker.bindPopup(`<div class="details-popup"><strong>${normalize(row["TERMINAL"])}</strong><br><em>${normalize(row["ADDRESS"])}</em><br><em>(${abbrev})</em></div>`);
      terminalMarkers.push({marker, row});
    }

    function getTypeAbbrev(type){
      if(!type) return "T";
      const mapType = {
        "Bus Terminal":"B",
        "Jeepney Terminal":"J",
        "Van Terminal":"V",
        "Common Terminal":"CT",
        "ITX":"ITX",
        "Tricycle Terminal":"T",
        "Offstreet Terminal":"OT",
        "Garage":"G"
      };
      return mapType[type] || type.split(" ").map(w=>w[0]).join("");
    }

    function showRouteList(overlaps, latlng){
      if(overlaps.length===0){ listPopup.style.display="none"; return; }
      listPopup.innerHTML = "";
      overlaps.forEach(r=>{
        const div = document.createElement("div");
        div.textContent = normalize(r.routeData["ROUTE NAME"]);
        div.onclick = ()=>{
          if(highlighted) highlighted.setStyle({weight:3, opacity:0.7});
          highlighted = r;
          r.setStyle({color:"red", weight:6, opacity:1});
          showRouteDetails(r.routeData, latlng);
        };
        listPopup.appendChild(div);
      });
      listPopup.style.display="block";
    }

    function showRouteDetails(row, latlng){
      const classVal = normalize(row["CLASS"]);
      const lengthFromSheet = normalize(row["ROUTE LENGTH"]);
      const lengthDisplay = lengthFromSheet ? (/[a-zA-Z%]/.test(lengthFromSheet) ? lengthFromSheet : lengthFromSheet+" km") : "N/A";

      const html = `
        <div class="details-popup">
          <div style="font-size:16px;font-weight:700;margin-bottom:6px">${normalize(row["ROUTE NAME"])}</div>
          <div><strong>DENO:</strong> ${normalize(row["DENO"])}</div>
          <div><strong>CLASS:</strong> ${classVal}</div>
          <div><strong>ROUTE CLASS:</strong> ${normalize(row["ROUTE CLASSIFICATION (if LPTRP)"])}</div>
          <div><strong>NAU:</strong> ${normalize(row["NO. OF AUTHORIZED UNITS"])}</div>
          <div><strong>BR. No.:</strong> ${normalize(row["BOARD RESOLUTION"])}</div>
          <div><strong>With LSO/LSR:</strong> ${normalize(row["WITH LSO/LSR"])}</div>
          <div><strong>MC No.:</strong> ${normalize(row["MEMORANDUM CIRCULAR"])}</div>
          <div><strong>ROUTE LENGTH:</strong> ${lengthDisplay}</div>
        </div>`;
      L.popup({offset:[150,0]}).setLatLng(latlng).setContent(html).openOn(map);
    }

    function isPointOnLine(latlng, poly){
      const dist = L.GeometryUtil.distance(map, latlng, poly);
      return dist < 20; // tolerance in meters
    }

    function randomColor(){
      return "#"+Math.floor(Math.random()*16777215).toString(16);
    }

    // Filtering
    function applyFilters(){
      const routeNameVal = normalize(document.getElementById("routeNameInput").value);
      const ep1Val = normalize(document.getElementById("ep1TerminalInput").value);
      const ep2Val = normalize(document.getElementById("ep2TerminalInput").value);

      routeLayers.forEach(r=>{
        const name = normalize(r.routeData["ROUTE NAME"]);
        const ep1 = normalize(r.routeData["ENDPOINT 1 TERMINAL"]);
        const ep2 = normalize(r.routeData["ENDPOINT 2 TERMINAL"]);

        let show = true;
        if(routeNameVal && !name.includes(routeNameVal)) show=false;
        if(ep1Val && ep1 !== ep1Val && ep2 !== ep1Val) show=false;
        if(ep2Val && ep1 !== ep2Val && ep2 !== ep2Val) show=false;

        if(show){ r.addTo(map); } else { map.removeLayer(r); }
      });

      terminalMarkers.forEach(t=>{
        const tname = normalize(t.row["TERMINAL"]);
        let show = true;
        if(ep1Val && tname !== ep1Val) show=false;
        if(ep2Val && tname !== ep2Val) show=false;
        if(show){ t.marker.addTo(map); } else { map.removeLayer(t.marker); }
      });
    }

    document.getElementById("routeNameInput").addEventListener("input", applyFilters);
    document.getElementById("ep1TerminalInput").addEventListener("input", applyFilters);
    document.getElementById("ep2TerminalInput").addEventListener("input", applyFilters);

    // Load Data
    Papa.parse(sheetUrlMaster, {
      download:true, header:true, complete: res=>{
        res.data.forEach(r=> addRoute(r));
        applyFilters();
      }
    });
    Papa.parse(sheetUrlTerminal, {
      download:true, header:true, complete: res=>{
        res.data.forEach(r=> addTerminal(r));
        applyFilters();
      }
    });

    map.on("click", ()=>{ listPopup.style.display="none"; map.closePopup(); if(highlighted){ highlighted.setStyle({weight:3, opacity:0.7}); highlighted=null; }});
  </script>
</body>
</html>
