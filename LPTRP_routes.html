<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>LTFRB Routes Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body { margin:0; padding:0; }
    #map { width:1170px; height:800px; }
    .filter-box {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1000;
      width: 280px;
      font-family: Arial, sans-serif;
    }
    .filter-box h4 {
      margin: 6px 0 4px;
      font-size: 14px;
    }
    .filter-box input, .filter-box select {
      width: 100%;
      padding: 5px;
      margin-bottom: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 13px;
    }
    .autocomplete-suggestions {
      border: 1px solid #ccc;
      border-top: none;
      max-height: 120px;
      overflow-y: auto;
      background: white;
      position: absolute;
      z-index: 2000;
      width: calc(100% - 12px);
    }
    .autocomplete-suggestions div {
      padding: 5px;
      cursor: pointer;
    }
    .autocomplete-suggestions div:hover {
      background: #f0f0f0;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="filter-box">
    <h4>Search by Route Name</h4>
    <input type="text" id="routeNameInput" placeholder="Type route name..." autocomplete="off">
    <div id="routeNameSuggestions" class="autocomplete-suggestions"></div>

    <h4>Search by Endpoints</h4>
    <input type="text" id="pointAInput" placeholder="Point A..." autocomplete="off">
    <div id="pointASuggestions" class="autocomplete-suggestions"></div>
    <input type="text" id="pointBInput" placeholder="Point B (optional)..." autocomplete="off">
    <div id="pointBSuggestions" class="autocomplete-suggestions"></div>
    <input type="text" id="viaInput" placeholder="Via (optional)..." autocomplete="off">
    <div id="viaSuggestions" class="autocomplete-suggestions"></div>
  </div>

  <script>
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRyCBsc0sCJs7FXH1Q1XEiCuMrV_ckVg9tcMvozYThFJfqpcOPdlo6YqxBYf6I1zHO0-yQZ_vz3knSS/pub?gid=1233383270&single=true&output=csv";

    const map = L.map('map').setView([12.8797, 121.7740], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    let allRoutes = [];
    let routeLayers = [];

    function randomColor() {
      return '#' + Math.floor(Math.random()*16777215).toString(16);
    }

    function highlightRoute(layer) {
      layer.setStyle({ color: 'yellow', weight: 5 });
      setTimeout(() => {
        layer.setStyle({ color: layer.options.originalColor, weight: 3 });
      }, 2000);
    }

    function addAutocomplete(inputId, suggestionId, values) {
      const input = document.getElementById(inputId);
      const box = document.getElementById(suggestionId);

      input.addEventListener("input", function() {
        const val = this.value.toLowerCase();
        box.innerHTML = "";
        if (!val) return;

        let matches = values.filter(v => v.toLowerCase().includes(val));
        matches.slice(0, 10).forEach(match => {
          const div = document.createElement("div");
          div.textContent = match;
          div.onclick = function() {
            input.value = match;
            box.innerHTML = "";
            applyFilters();
          };
          box.appendChild(div);
        });
      });
    }

    function applyFilters() {
      const nameVal = document.getElementById("routeNameInput").value.toLowerCase();
      const pointAVal = document.getElementById("pointAInput").value.toLowerCase();
      const pointBVal = document.getElementById("pointBInput").value.toLowerCase();
      const viaVal = document.getElementById("viaInput").value.toLowerCase();

      routeLayers.forEach(layer => map.removeLayer(layer));
      routeLayers = [];

      allRoutes.forEach(r => {
        let match = true;
        if (nameVal && !r["ROUTE NAME"].toLowerCase().includes(nameVal)) match = false;
        if (pointAVal && !Object.values(r).some(v => v && v.toLowerCase().includes(pointAVal))) match = false;
        if (pointBVal && !Object.values(r).some(v => v && v.toLowerCase().includes(pointBVal))) match = false;
        if (viaVal && !Object.values(r).some(v => v && v.toLowerCase().includes(viaVal))) match = false;

        if (match && r._layer) {
          r._layer.addTo(map);
          routeLayers.push(r._layer);
        }
      });
    }

    Papa.parse(sheetUrl, {
      download: true,
      header: true,
      complete: function(results) {
        allRoutes = results.data;

        let routeNames = [...new Set(allRoutes.map(r => r["ROUTE NAME"]).filter(Boolean))];
        let endpoints = [...new Set(
          allRoutes.flatMap(r => [
            r["ENDPOINT 1 REGION"], r["ENDPOINT 1 PROVINCE"], r["ENDPOINT 1 LGU"],
            r["ENDPOINT 1 BARANGAY"], r["ENDPOINT 1 TERMINAL"],
            r["ENDPOINT 2 REGION"], r["ENDPOINT 2 PROVINCE"], r["ENDPOINT 2 LGU"],
            r["ENDPOINT 2 BARANGAY"], r["ENDPOINT 2 TERMINAL"]
          ]).filter(Boolean)
        )];
        let vias = [...new Set(allRoutes.flatMap(r => [r["ROUTE STRUCTURE"], r["CORRIDOR"]]).filter(Boolean))];

        addAutocomplete("routeNameInput", "routeNameSuggestions", routeNames);
        addAutocomplete("pointAInput", "pointASuggestions", endpoints);
        addAutocomplete("pointBInput", "pointBSuggestions", endpoints);
        addAutocomplete("viaInput", "viaSuggestions", vias);

        allRoutes.forEach(route => {
          if (!route["GEO PATH"]) return;
          try {
            const coords = JSON.parse(route["GEO PATH"]);
            const poly = L.polyline(coords, {
              color: randomColor(),
              weight: 3,
              originalColor: randomColor()
            }).addTo(map);

            poly.on("mouseover", () => {
              poly.setStyle({ color: "yellow", weight: 5 });
            });
            poly.on("mouseout", () => {
              poly.setStyle({ color: poly.options.originalColor, weight: 3 });
            });

            poly.on("click", (e) => {
              const overlapping = allRoutes.filter(r => {
                if (!r._layer) return false;
                return r._layer.getBounds().contains(e.latlng);
              });
              let list = "<b>Routes at this point:</b><br>";
              overlapping.forEach(r => {
                list += `<div style='cursor:pointer;color:blue' onclick="window.highlight('${r['ROUTE NAME']}')">${r['ROUTE NAME']}</div>`;
              });
              L.popup().setLatLng(e.latlng).setContent(list).openOn(map);
            });

            route._layer = poly;
            routeLayers.push(poly);
          } catch(e) { console.log("Bad GEO PATH", e); }
        });
      }
    });

    window.highlight = function(routeName) {
      const route = allRoutes.find(r => r["ROUTE NAME"] === routeName);
      if (route && route._layer) {
        map.fitBounds(route._layer.getBounds());
        highlightRoute(route._layer);
        route._layer.bindPopup(
          `<b>${route["ROUTE NAME"]}</b><br>DENO: ${route["DENO"]}<br>Class: ${route["Class"]}<br>Route Class: ${route["ROUTE CLASSIFICATION (if LPTRP)"]}<br>NAU: ${route["NO. OF AUTHORIZED UNITS"]}`
        ).openPopup();
      }
    };
  </script>
</body>
</html>
