<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Transport Routes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    #map { width: 1170px; height: 800px; }
    .search-box {
      background: white;
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-size: 13px;
      width: 280px;
    }
    .search-box input {
      width: 100%;
      padding: 6px;
      margin: 3px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .popup-list {
      max-height: 200px;
      overflow-y: auto;
      font-size: 13px;
    }
    .popup-list div {
      cursor: pointer;
      padding: 4px;
    }
    .popup-list div:hover { background: #f0f0f0; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // === Map Initialization ===
    var map = L.map('map').setView([12.8797, 121.7740], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map);

    // Layers + State
    var allRoutes = [];
    var activeHighlight = null;
    var activePopup = null;

    // === Fetch CSV from Google Sheets ===
    var sheetUrl = "https://docs.google.com/spreadsheets/d/1CyoUxFDCCgDArR1iTMZJG02RTke8QoTzL7HhHwcwk6k/pub?gid=0&single=true&output=csv";

    Papa.parse(sheetUrl, {
      download: true,
      header: true,
      complete: function(results) {
        results.data.forEach(function(row) {
          if (row["GEO PATH"]) {
            try {
              var coords = JSON.parse(row["GEO PATH"]);
              var latlngs = coords.map(c => [c[1], c[0]]);

              var poly = L.polyline(latlngs, {
                color: getRandomColor(),
                weight: 3,
                opacity: 0.8
              }).addTo(map);

              poly.routeData = row;
              allRoutes.push(poly);

              // Hover: count overlaps
              poly.on('mouseover', function(e) {
                var overlapping = getOverlappingRoutes(e.latlng);
                this.setStyle({weight: 6});
                var popup = L.popup({offset:[0,-10], closeButton:false})
                  .setLatLng(e.latlng)
                  .setContent("<b>"+overlapping.length+" route(s) here</b>")
                  .openOn(map);
              });
              poly.on('mouseout', function() {
                this.setStyle({weight: 3});
                map.closePopup();
              });

              // Click: list routes
              poly.on('click', function(e) {
                if (activePopup) map.closePopup(activePopup);
                if (activeHighlight) activeHighlight.setStyle({opacity:0.8, weight:3});

                var overlapping = getOverlappingRoutes(e.latlng);
                var listHtml = "<div class='popup-list'>";
                overlapping.forEach(function(r,i){
                  listHtml += "<div onclick=\"showRouteDetails("+allRoutes.indexOf(r)+", ["+e.latlng.lat+","+e.latlng.lng+"])\">"+r.routeData["ROUTE NAME"]+"</div>";
                });
                listHtml += "</div>";

                activePopup = L.popup({closeOnClick:false, autoClose:false})
                  .setLatLng(e.latlng)
                  .setContent(listHtml)
                  .openOn(map);
              });

            } catch(err) { console.error("Bad GEO PATH", row["GEO PATH"]); }
          }
        });
      }
    });

    // === Helpers ===
    function getOverlappingRoutes(latlng) {
      var tol = 0.001;
      return allRoutes.filter(function(r){
        return r.getLatLngs().some(function(seg){
          return seg.some(function(p){
            return Math.abs(p.lat-latlng.lat)<tol && Math.abs(p.lng-latlng.lng)<tol;
          });
        });
      });
    }

    function showRouteDetails(index, latlng) {
      if (activeHighlight) activeHighlight.setStyle({opacity:0.8, weight:3});
      var r = allRoutes[index];
      r.setStyle({color:"red", weight:6, opacity:1});
      activeHighlight = r;

      var d = r.routeData;
      var html = "<b>"+d["ROUTE NAME"]+"</b><br/>"+
                 "DENO: "+d["DENO"]+"<br/>"+
                 "Class: "+d["Class"]+"<br/>"+
                 "Route Class: "+d["ROUTE CLASSIFICATION (if LPTRP)"]+"<br/>"+
                 "NAU: "+d["NO. OF AUTHORIZED UNITS"];

      L.popup({autoClose:true})
        .setLatLng(latlng)
        .setContent(html)
        .openOn(map);
    }

    function getRandomColor() {
      return '#'+Math.floor(Math.random()*16777215).toString(16);
    }

    // Clear highlights when clicking empty map
    map.on('click', function(e){
      if (activeHighlight) activeHighlight.setStyle({opacity:0.8, weight:3});
      activeHighlight = null;
      map.closePopup();
    });
  </script>
</body>
</html>
