<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>LPTRP Route Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
  body { margin:0; padding:0; }
  #map { width: 100%; height: 700px; }
  .search-container {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1000;
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
    max-width: 350px;
    font-family: Arial, sans-serif;
  }
  .search-container h4 {
    margin: 6px 0 4px;
  }
  .search-container input, .search-container select, .search-container button {
    width: 100%;
    margin-bottom: 6px;
    padding: 5px;
    font-size: 14px;
  }
  .leaflet-popup-content {
    font-size: 14px;
  }
</style>
</head>
<body>

<div id="map"></div>

<div class="search-container">
  <h4>Search by Route Name</h4>
  <input id="routeNameInput" list="routeNameList" placeholder="Select Route">
  <datalist id="routeNameList"></datalist>

  <h4>Search by Endpoints</h4>
  <strong>Endpoint 1</strong>
  <input id="ep1Region" list="ep1RegionList" placeholder="Select Region">
  <datalist id="ep1RegionList"></datalist>
  <input id="ep1Province" list="ep1ProvinceList" placeholder="Select Province">
  <datalist id="ep1ProvinceList"></datalist>
  <input id="ep1LGU" list="ep1LGUList" placeholder="Select LGU">
  <datalist id="ep1LGUList"></datalist>
  <input id="ep1Barangay" list="ep1BarangayList" placeholder="Select Barangay">
  <datalist id="ep1BarangayList"></datalist>
  <input id="ep1Terminal" list="ep1TerminalList" placeholder="Select Terminal">
  <datalist id="ep1TerminalList"></datalist>

  <strong>Endpoint 2</strong>
  <input id="ep2Region" list="ep2RegionList" placeholder="Select Region">
  <datalist id="ep2RegionList"></datalist>
  <input id="ep2Province" list="ep2ProvinceList" placeholder="Select Province">
  <datalist id="ep2ProvinceList"></datalist>
  <input id="ep2LGU" list="ep2LGUList" placeholder="Select LGU">
  <datalist id="ep2LGUList"></datalist>
  <input id="ep2Barangay" list="ep2BarangayList" placeholder="Select Barangay">
  <datalist id="ep2BarangayList"></datalist>
  <input id="ep2Terminal" list="ep2TerminalList" placeholder="Select Terminal">
  <datalist id="ep2TerminalList"></datalist>

  <button onclick="applyFilters()">Apply Filters</button>
  <button onclick="clearFilters()">Clear Filters</button>
</div>

<script>
const sheetUrl = "YOUR_PUBLISHED_CSV_URL"; // Replace with your CSV link

let allData = [];
let routeLayers = [];

const map = L.map('map').setView([12.8797, 121.7740], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

function getRandomDarkColor() {
  const r = Math.floor(Math.random() * 128);
  const g = Math.floor(Math.random() * 128);
  const b = Math.floor(Math.random() * 128);
  return `rgb(${r},${g},${b})`;
}

function loadData() {
  Papa.parse(sheetUrl, {
    download: true,
    header: true,
    complete: function(results) {
      allData = results.data;
      populateSuggestions();
      drawRoutes(allData);
    }
  });
}

function populateSuggestions() {
  const uniqueValues = (col) => [...new Set(allData.map(row => row[col]?.trim()).filter(v => v))].sort();

  fillDatalist('routeNameList', uniqueValues('ROUTE NAME'));
  fillDatalist('ep1RegionList', uniqueValues('ENDPOINT 1 REGION'));
  fillDatalist('ep1ProvinceList', uniqueValues('ENDPOINT 1 PROVINCE'));
  fillDatalist('ep1LGUList', uniqueValues('ENDPOINT 1 LGU'));
  fillDatalist('ep1BarangayList', uniqueValues('ENDPOINT 1 BARANGAY'));
  fillDatalist('ep1TerminalList', uniqueValues('ENDPOINT 1 TERMINAL'));
  fillDatalist('ep2RegionList', uniqueValues('ENDPOINT 2 REGION'));
  fillDatalist('ep2ProvinceList', uniqueValues('ENDPOINT 2 PROVINCE'));
  fillDatalist('ep2LGUList', uniqueValues('ENDPOINT 2 LGU'));
  fillDatalist('ep2BarangayList', uniqueValues('ENDPOINT 2 BARANGAY'));
  fillDatalist('ep2TerminalList', uniqueValues('ENDPOINT 2 TERMINAL'));
}

function fillDatalist(id, values) {
  const dl = document.getElementById(id);
  dl.innerHTML = '';
  values.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v;
    dl.appendChild(opt);
  });
}

function drawRoutes(data) {
  routeLayers.forEach(layer => map.removeLayer(layer));
  routeLayers = [];

  data.forEach(row => {
    if (!row['GEO PATH']) return;
    try {
      const coords = JSON.parse(row['GEO PATH']);
      const color = getRandomDarkColor();
      const polyline = L.polyline(coords, { color, weight: 3 }).addTo(map);
      polyline.bindPopup(`
        <strong>${row['ROUTE NAME']}</strong><br>
        DENO: ${row['DENO'] || ''}<br>
        NAU: ${row['NO. OF AUTHORIZED UNITS'] || ''}<br>
        Classification: ${row['ROUTE CLASSIFICATION (if LPTRP)'] || ''}
      `);
      routeLayers.push(polyline);
    } catch (e) {}
  });
}

function applyFilters() {
  const filters = {
    routeName: document.getElementById('routeNameInput').value.trim(),
    ep1Region: document.getElementById('ep1Region').value.trim(),
    ep1Province: document.getElementById('ep1Province').value.trim(),
    ep1LGU: document.getElementById('ep1LGU').value.trim(),
    ep1Barangay: document.getElementById('ep1Barangay').value.trim(),
    ep1Terminal: document.getElementById('ep1Terminal').value.trim(),
    ep2Region: document.getElementById('ep2Region').value.trim(),
    ep2Province: document.getElementById('ep2Province').value.trim(),
    ep2LGU: document.getElementById('ep2LGU').value.trim(),
    ep2Barangay: document.getElementById('ep2Barangay').value.trim(),
    ep2Terminal: document.getElementById('ep2Terminal').value.trim(),
  };

  const filtered = allData.filter(row => {
    return (!filters.routeName || row['ROUTE NAME'] === filters.routeName) &&
           (!filters.ep1Region || row['ENDPOINT 1 REGION'] === filters.ep1Region) &&
           (!filters.ep1Province || row['ENDPOINT 1 PROVINCE'] === filters.ep1Province) &&
           (!filters.ep1LGU || row['ENDPOINT 1 LGU'] === filters.ep1LGU) &&
           (!filters.ep1Barangay || row['ENDPOINT 1 BARANGAY'] === filters.ep1Barangay) &&
           (!filters.ep1Terminal || row['ENDPOINT 1 TERMINAL'] === filters.ep1Terminal) &&
           (!filters.ep2Region || row['ENDPOINT 2 REGION'] === filters.ep2Region) &&
           (!filters.ep2Province || row['ENDPOINT 2 PROVINCE'] === filters.ep2Province) &&
           (!filters.ep2LGU || row['ENDPOINT 2 LGU'] === filters.ep2LGU) &&
           (!filters.ep2Barangay || row['ENDPOINT 2 BARANGAY'] === filters.ep2Barangay) &&
           (!filters.ep2Terminal || row['ENDPOINT 2 TERMINAL'] === filters.ep2Terminal);
  });

  drawRoutes(filtered);
}

function clearFilters() {
  document.querySelectorAll('.search-container input').forEach(el => el.value = '');
  drawRoutes(allData);
}

loadData();
</script>
</body>
</html>
