<!DOCTYPE html>
<html>
<head>
  <title>LPTRP Route Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100vh; width: 100%; }

    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 300px;
    }

    .controls h4 {
      margin: 0 0 10px;
    }

    .controls label {
      display: block;
      margin-top: 5px;
      font-weight: bold;
    }

    .controls input, .controls select {
      width: 100%;
      padding: 4px;
      margin-bottom: 8px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="controls">
    <h4>Search by Route Name</h4>
    <input type="text" id="routeSearch" placeholder="Enter route name...">

    <h4>Search by Endpoints</h4>
    <label for="pointA">Point A</label>
    <select id="pointA">
      <option value="">-- Choose --</option>
      <option value="region">Region</option>
      <option value="province">Province</option>
      <option value="lgu">LGU</option>
      <option value="barangay">Barangay</option>
      <option value="terminal">Terminal</option>
    </select>

    <label for="pointB">Point B</label>
    <select id="pointB">
      <option value="">-- Choose --</option>
      <option value="region">Region</option>
      <option value="province">Province</option>
      <option value="lgu">LGU</option>
      <option value="barangay">Barangay</option>
      <option value="terminal">Terminal</option>
    </select>

    <label for="via">Via</label>
    <select id="via">
      <option value="">-- Choose --</option>
      <option value="road">Road</option>
      <option value="lgu">LGU</option>
    </select>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- PapaParse -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const map = L.map('map').setView([13, 122], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Scale bar and north arrow
    L.control.scale().addTo(map);
    const north = L.control({position: "bottomleft"});
    north.onAdd = function(map) {
      const div = L.DomUtil.create("div", "info legend");
      div.innerHTML = '<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2f/Compass_rose_pale.svg/120px-Compass_rose_pale.svg.png" width="50">';
      return div;
    }
    north.addTo(map);

    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRyCBsc0sCJs7FXH1Q1XEiCuMrV_ckVg9tcMvozYThFJfqpcOPdlo6YqxBYf6I1zHO0-yQZ_vz3knSS/pub?gid=1233383270&single=true&output=csv";

    async function loadRoutes() {
      const response = await fetch(csvUrl);
      const csvText = await response.text();

      Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          const data = results.data;
          let validCount = 0;

          data.forEach((row, index) => {
            const geoPathRaw = row["GEO PATH"];
            if (!geoPathRaw || geoPathRaw.trim() === "") return;

            try {
              const coords = JSON.parse(geoPathRaw);
              const latlngs = coords.map(c => [c[1], c[0]]);

              const polyline = L.polyline(latlngs, { color: getRandomColor() }).addTo(map);
              polyline.bindPopup(`
                <strong>${row["ROUTE NAME"] || 'Unnamed Route'}</strong><br>
                <b>DENO:</b> ${row["DENO"] || '-'}<br>
                <b>NAU:</b> ${row["NO. OF AUTHORIZED UNITS"] || '-'}<br>
                <b>CLASSIFICATION:</b> ${row["ROUTE CLASSIFICATION (if LPTRP)"] || '-'}`);

              validCount++;
            } catch (e) {
              console.warn(`Invalid GEO PATH at row ${index + 2}`);
            }
          });

          console.log(`ðŸŸ¢ Valid routes loaded: ${validCount}`);
        }
      });
    }

    function getRandomColor() {
      return '#' + Math.floor(Math.random()*16777215).toString(16);
    }

    loadRoutes();
  </script>
</body>
</html>
