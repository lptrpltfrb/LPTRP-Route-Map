<!DOCTYPE html>
<html>
<head>
  <title>Transport Routes Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body { margin:0; padding:0; }
    #map { width:1170px; height:800px; }

    .search-box {
      position:absolute; top:10px; left:10px; 
      background:white; padding:10px;
      z-index:1000; border-radius:8px; 
      max-width:300px; box-shadow:0 2px 6px rgba(0,0,0,0.3);
    }
    .route-list-popup {
      max-height:150px;
      overflow-y:auto;
      margin:0;
      padding:0;
      list-style:none;
    }
    .route-list-popup li {
      cursor:pointer;
      padding:3px 5px;
    }
    .route-list-popup li:hover {
      background:#f0f0f0;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="search-box">
    <h4>Search by Route Name</h4>
    <input type="text" id="routeSearch" placeholder="Type route name..." style="width:100%; margin-bottom:8px;">
    
    <h4>Search by Endpoints</h4>
    <select id="pointA" style="width:100%; margin-bottom:5px;">
      <option value="">Point A</option>
    </select>
    <select id="pointB" style="width:100%; margin-bottom:5px;">
      <option value="">Point B (Optional)</option>
    </select>
    <select id="via" style="width:100%; margin-bottom:5px;">
      <option value="">Via (Optional)</option>
    </select>
    <button onclick="applyFilters()">Apply Filters</button>
  </div>

<script>
const map = L.map('map').setView([12.8797, 121.7740], 6); // Philippines center
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let allRoutes = [];
let routeLayers = [];
let highlightedRoutes = [];
let hoverPopup = null;
let listPopup = null;
let detailPopup = null;

// Load CSV from Google Sheets
Papa.parse("YOUR_PUBLISHED_SHEET_CSV_URL", {
  download: true,
  header: true,
  complete: function(results) {
    results.data.forEach(row => {
      if (!row["GEO PATH"]) return;
      try {
        const coords = JSON.parse(row["GEO PATH"]);
        const polyline = L.polyline(coords, {color: randomColor(), weight: 3}).addTo(map);
        polyline.routeData = {
          name: row["ROUTE NAME"],
          deno: row["DENO"],
          class: row["Class"],
          routeClass: row["ROUTE CLASSIFICATION (if LPTRP)"],
          nau: row["NO. OF AUTHORIZED UNITS"]
        };
        allRoutes.push(polyline);
        routeLayers.push(polyline);
      } catch(e) {
        console.warn("Invalid GEO PATH", row["ROUTE NAME"]);
      }
    });
  }
});

// Random color
function randomColor() {
  return '#'+Math.floor(Math.random()*16777215).toString(16);
}

// Hover detect overlaps
map.on('mousemove', function(e){
  let overlapping = [];
  allRoutes.forEach(r => {
    if (L.GeometryUtil.isPointOnLine(map, e.latlng, r)) {
      overlapping.push(r);
    }
  });
  if (hoverPopup) map.removeLayer(hoverPopup);
  if (overlapping.length > 0) {
    overlapping.forEach(r => r.setStyle({weight:5}));
    highlightedRoutes = overlapping;
    hoverPopup = L.popup({closeButton:false, autoClose:true})
      .setLatLng(e.latlng)
      .setContent(overlapping.length+" routes overlap here")
      .openOn(map);
  } else {
    highlightedRoutes.forEach(r => r.setStyle({weight:3}));
    highlightedRoutes = [];
    if (hoverPopup) map.removeLayer(hoverPopup);
  }
});

// Click: show route list
map.on('click', function(e){
  clearHighlights();
  let overlapping = [];
  allRoutes.forEach(r => {
    if (L.GeometryUtil.isPointOnLine(map, e.latlng, r)) {
      overlapping.push(r);
    }
  });
  if (overlapping.length > 0) {
    let listHtml = "<ul class='route-list-popup'>";
    overlapping.forEach((r,i)=>{
      listHtml += `<li onclick="showRouteDetails(${routeLayers.indexOf(r)}, [${e.latlng.lat}, ${e.latlng.lng}])">${r.routeData.name}</li>`;
    });
    listHtml += "</ul>";
    listPopup = L.popup().setLatLng(e.latlng).setContent(listHtml).openOn(map);
  } else {
    map.closePopup();
  }
});

// Show route details
function showRouteDetails(index, latlng){
  clearHighlights();
  const r = routeLayers[index];
  r.setStyle({color:'red', weight:6});
  detailPopup = L.popup()
    .setLatLng(latlng)
    .setContent(
      "<b>"+r.routeData.name+"</b><br>"+
      "DENO: "+r.routeData.deno+"<br>"+
      "Class: "+r.routeData.class+"<br>"+
      "Route Class: "+r.routeData.routeClass+"<br>"+
      "NAU: "+r.routeData.nau
    )
    .openOn(map);
}

// Clear highlights
function clearHighlights(){
  allRoutes.forEach(r => r.setStyle({color: r.options.color, weight:3}));
  if (detailPopup) map.closePopup(detailPopup);
}

// Placeholder for filters
function applyFilters(){
  alert("Filters coming soon...");
}
</script>
<script src="https://unpkg.com/leaflet-geometryutil"></script>
</body>
</html>
