<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>LPTRP Route Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css"/>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>

  <style>
    body{margin:0;padding:0;font-family:Arial,sans-serif;}
    #map{width:1170px;height:800px;}

    /* Filter box styling */
    .filter-box{
      position:absolute;
      top:10px;
      left:10px;
      width:300px;
      background:#fff;
      padding:10px;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      z-index:1000;
      overflow:auto;
      max-height:780px;
    }
    .filter-box h4{margin:4px 0;font-size:14px;}
    .filter-box label{font-size:12px;margin-top:6px;display:block;}
    .filter-box input{width:100%;padding:4px 6px;margin-bottom:4px;border:1px solid #ccc;border-radius:4px;font-size:12px;box-sizing:border-box;}
    .filter-box button{width:100%;padding:6px;margin-top:6px;border:none;border-radius:4px;background:#2f78a0;color:#fff;cursor:pointer;font-size:13px;}
  </style>
</head>
<body>
<div id="map"></div>

<div class="filter-box">
  <h4>Search by Route Name</h4>
  <input id="routeName" placeholder="Type route name..."/>
  <h4>Search by Endpoints</h4>
  <label>End Point 1 Region</label><input id="ep1Region" placeholder="Type region..."/>
  <label>End Point 1 Province</label><input id="ep1Province" placeholder="Type province..."/>
  <label>End Point 1 LGU</label><input id="ep1LGU" placeholder="Type LGU..."/>
  <label>End Point 1 Barangay</label><input id="ep1Barangay" placeholder="Type barangay..."/>
  <label>End Point 1 Terminal</label><input id="ep1Terminal" placeholder="Type terminal..."/>

  <label>End Point 2 Region</label><input id="ep2Region" placeholder="Type region..."/>
  <label>End Point 2 Province</label><input id="ep2Province" placeholder="Type province..."/>
  <label>End Point 2 LGU</label><input id="ep2LGU" placeholder="Type LGU..."/>
  <label>End Point 2 Barangay</label><input id="ep2Barangay" placeholder="Type barangay..."/>
  <label>End Point 2 Terminal</label><input id="ep2Terminal" placeholder="Type terminal..."/>

  <button id="applyFilter">Apply Filter</button>
  <button id="clearFilter">Clear Filter</button>
</div>

<script>
const map = L.map('map').setView([13,122],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18, attribution:'Â© OpenStreetMap'}).addTo(map);

const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRyCBsc0sCJs7FXH1Q1XEiCuMrV_ckVg9tcMvozYThFJfqpcOPdlo6YqxBYf6I1zHO0-yQZ_vz3knSS/pub?gid=1233383270&single=true&output=csv";

let allData=[], routeLayers=[], hoveredLayer=null, clickedLayer=null;
let listPopup=null, detailPopup=null;

function normalize(s){return s?s.toString().trim():"";}

function colorFromString(str){
  const colors=['#0b3d91','#1b5e20','#b71c1c','#ff6f00','#4a148c','#3e2723','#263238','#006064','#004d40','#0d47a1'];
  let hash=0; for(let i=0;i<str.length;i++){hash=(hash<<5)-hash+str.charCodeAt(i);hash|=0;}
  return colors[Math.abs(hash)%colors.length];
}

function drawRoute(row){
  if(!row["GEO PATH"]) return;
  let coords;
  try{coords=JSON.parse(row["GEO PATH"])}catch(e){return;}
  if(!Array.isArray(coords)) return;
  if(!Array.isArray(coords[0][0])) coords=[coords];

  const routeName=normalize(row["ROUTE NAME"]);
  const baseColor=colorFromString(routeName);

  coords.forEach(seg=>{
    const latlngs=seg.map(c=>[+c[1],+c[0]]);
    const pl=L.polyline(latlngs,{color:baseColor,weight:4,opacity:0.95}).addTo(map);
    pl.options.baseColor=baseColor;
    pl.options.routeName=routeName;
    pl.options.rowData=row;

    pl.on('mouseover',()=>{
      if(hoveredLayer!==pl){
        pl.setStyle({color:'yellow',weight:7,opacity:1});
        hoveredLayer=pl;
        // Count unique route names overlapping at this polyline's bounds
        const overlapNames=[...new Set(routeLayers.filter(l=>l.getBounds().intersects(pl.getBounds())).map(l=>l.options.routeName))];
        if(listPopup) map.removeLayer(listPopup);
        listPopup=L.popup({closeButton:false,offset:[0,-10]}).setLatLng(pl.getBounds().getCenter()).setContent(`Routes at this point: ${overlapNames.length}`).openOn(map);
      }
    });

    pl.on('mouseout',()=>{
      if(pl!==clickedLayer) pl.setStyle({color:pl.options.baseColor,weight:4,opacity:0.95});
      if(listPopup){ map.removeLayer(listPopup); listPopup=null; }
      hoveredLayer=null;
    });

    pl.on('click',()=>{
      // List of routes at this point
      const overlapLayers=routeLayers.filter(l=>l.getBounds().intersects(pl.getBounds()));
      const uniqueRoutes=[...new Map(overlapLayers.map(l=>[l.options.routeName,l])).values()];
      let html='<div style="max-height:250px;overflow:auto;">';
      uniqueRoutes.forEach(l=>{
        html+=`<div style="cursor:pointer;color:${l.options.baseColor}" onclick="showRouteDetail('${l.options.routeName}')">${l.options.routeName}</div>`;
      });
      html+='</div>';
      if(listPopup) map.removeLayer(listPopup);
      listPopup=L.popup({maxWidth:300,autoClose:false,closeOnClick:false}).setLatLng(pl.getBounds().getCenter()).setContent(html).openOn(map);
    });

    routeLayers.push(pl);
  });
}

// Show route details popup
function showRouteDetail(name){
  if(detailPopup) map.removeLayer(detailPopup);
  if(clickedLayer) clickedLayer.setStyle({color:clickedLayer.options.baseColor,weight:4,opacity:0.95});
  const layer=routeLayers.find(l=>l.options.routeName===name);
  if(!layer) return;
  clickedLayer=layer;
  layer.setStyle({color:'yellow',weight:7,opacity:1});
  const row=layer.options.rowData;
  detailPopup=L.popup({maxWidth:300,autoClose:false,closeOnClick:false})
    .setLatLng(layer.getBounds().getCenter())
    .setContent(`<div style="font-weight:bold;">${normalize(row["ROUTE NAME"])}</div>
                 <div>DENO: ${normalize(row["DENO"])}</div>
                 <div>CLASS: ${normalize(row["Class"])}</div>
                 <div>ROUTE CLASS: ${normalize(row["ROUTE CLASSIFICATION (if LPTRP)"])}</div>
                 <div>NAU: ${normalize(row["NO. OF AUTHORIZED UNITS"])}</div>
                 <div>ROUTE LENGTH: ${normalize(row["ROUTE LENGTH"])}</div>`).openOn(map);
}

// Clear on empty map click
map.on('click',()=>{ 
  if(clickedLayer){clickedLayer.setStyle({color:clickedLayer.options.baseColor,weight:4,opacity:0.95); clickedLayer=null;}
  if(listPopup){map.removeLayer(listPopup); listPopup=null;}
  if(detailPopup){map.removeLayer(detailPopup); detailPopup=null;}
  if(hoveredLayer){hoveredLayer=null;}
});

Papa.parse(csvUrl,{download:true,header:true,complete:function(results){
  allData=results.data;
  allData.forEach(drawRoute);

  // --- Autocomplete ---
  function combineColumns(col1,col2){return [...new Set(allData.map(r=>normalize(r[col1])).filter(Boolean).concat(allData.map(r=>normalize(r[col2])).filter(Boolean)))];}
  $("#routeName").autocomplete({source:[...new Set(allData.map(r=>normalize(r["ROUTE NAME"])).filter(Boolean))]});
  $("#ep1Region").autocomplete({source:combineColumns("ENDPOINT 1 REGION","ENDPOINT 2 REGION")});
  $("#ep1Province").autocomplete({source:combineColumns("ENDPOINT 1 PROVINCE","ENDPOINT 2 PROVINCE")});
  $("#ep1LGU").autocomplete({source:combineColumns("ENDPOINT 1 LGU","ENDPOINT 2 LGU")});
  $("#ep1Barangay").autocomplete({source:combineColumns("ENDPOINT 1 BARANGAY","ENDPOINT 2 BARANGAY")});
  $("#ep1Terminal").autocomplete({source:combineColumns("ENDPOINT 1 TERMINAL","ENDPOINT 2 TERMINAL")});

  $("#ep2Region").autocomplete({source:combineColumns("ENDPOINT 1 REGION","ENDPOINT 2 REGION")});
  $("#ep2Province").autocomplete({source:combineColumns("ENDPOINT 1 PROVINCE","ENDPOINT 2 PROVINCE")});
  $("#ep2LGU").autocomplete({source:combineColumns("ENDPOINT 1 LGU","ENDPOINT 2 LGU")});
  $("#ep2Barangay").autocomplete({source:combineColumns("ENDPOINT 1 BARANGAY","ENDPOINT 2 BARANGAY")});
  $("#ep2Terminal").autocomplete({source:combineColumns("ENDPOINT 1 TERMINAL","ENDPOINT 2 TERMINAL")});
}});

// Apply filter
$("#applyFilter").on('click',function(){
  const vals={routeName:nLower($("#routeName").val()),
              ep1Region:nLower($("#ep1Region").val()), ep1Province:nLower($("#ep1Province").val()), ep1LGU:nLower($("#ep1LGU").val()), ep1Barangay:nLower($("#ep1Barangay").val()), ep1Terminal:nLower($("#ep1Terminal").val()),
              ep2Region:nLower($("#ep2Region").val()), ep2Province:nLower($("#ep2Province").val()), ep2LGU:nLower($("#ep2LGU").val()), ep2Barangay:nLower($("#ep2Barangay").val()), ep2Terminal:nLower($("#ep2Terminal").val())
             };
  routeLayers.forEach(l=>map.removeLayer(l));
  routeLayers=[];
  allData.forEach(r=>{
    function match(val,col){return !val || normalize(r[col]).toLowerCase().includes(val);}
    if(match(vals.routeName,"ROUTE NAME") &&
       match(vals.ep1Region,"ENDPOINT 1 REGION") || match(vals.ep1Region,"ENDPOINT 2 REGION") &&
       match(vals.ep1Province,"ENDPOINT 1 PROVINCE") || match(vals.ep1Province,"ENDPOINT 2 PROVINCE") &&
       match(vals.ep1LGU,"ENDPOINT 1 LGU") || match(vals.ep1LGU,"ENDPOINT 2 LGU") &&
       match(vals.ep1Barangay,"ENDPOINT 1 BARANGAY") || match(vals.ep1Barangay,"ENDPOINT 2 BARANGAY") &&
       match(vals.ep1Terminal,"ENDPOINT 1 TERMINAL") || match(vals.ep1Terminal,"ENDPOINT 2 TERMINAL") &&
       match(vals.ep2Region,"ENDPOINT 1 REGION") || match(vals.ep2Region,"ENDPOINT 2 REGION") &&
       match(vals.ep2Province,"ENDPOINT 1 PROVINCE") || match(vals.ep2Province,"ENDPOINT 2 PROVINCE") &&
       match(vals.ep2LGU,"ENDPOINT 1 LGU") || match(vals.ep2LGU,"ENDPOINT 2 LGU") &&
       match(vals.ep2Barangay,"ENDPOINT 1 BARANGAY") || match(vals.ep2Barangay,"ENDPOINT 2 BARANGAY") &&
       match(vals.ep2Terminal,"ENDPOINT 1 TERMINAL") || match(vals.ep2Terminal,"ENDPOINT 2 TERMINAL")
      ) drawRoute(r);
  });
});

// Clear filter
$("#clearFilter").on('click',function(){
  $("#routeName,#ep1Region,#ep1Province,#ep1LGU,#ep1Barangay,#ep1Terminal,#ep2Region,#ep2Province,#ep2LGU,#ep2Barangay,#ep2Terminal").val('');
  routeLayers.forEach(l=>map.removeLayer(l));
  routeLayers=[];
  allData.forEach(drawRoute);
});

function nLower(s){return s?s.toLowerCase():"";}
</script>
</body>
</html>
