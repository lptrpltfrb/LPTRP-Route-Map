<script>
  const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRyCBsc0sCJs7FXH1Q1XEiCuMrV_ckVg9tcMvozYThFJfqpcOPdlo6YqxBYf6I1zHO0-yQZ_vz3knSS/pub?gid=1233383270&single=true&output=csv';

  const map = L.map('map').setView([15.8, 120.6], 9);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  fetch(sheetURL)
    .then(response => response.text())
    .then(csvText => {
      const rows = csvText.split('\n').slice(1);
      for (let row of rows) {
        const columns = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); // handles commas inside quotes
        const routeName = columns[9]?.trim(); // "Route Name"
        const geoPathText = columns[26]?.trim(); // "GEO PATH"

        if (geoPathText && geoPathText.startsWith('[[')) {
          try {
            const coordinates = JSON.parse(geoPathText);
            const latlngs = coordinates.map(coord => [coord[1], coord[0]]);
            const polyline = L.polyline(latlngs, { color: 'blue' }).addTo(map);
            polyline.bindPopup(routeName || 'Unnamed Route');
          } catch (e) {
            console.warn('Invalid GEO PATH JSON for route:', routeName, e);
          }
        }
      }
    });
</script>
