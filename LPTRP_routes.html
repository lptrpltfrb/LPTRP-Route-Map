<!DOCTYPE html>
<html><head>
  <meta charset="utf-8">
  <title>LTFRB Route Debug</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>#map{height:100vh;width:100%;}</style>
</head><body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    alert("Script started"); // Step 1

    const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRyCBsc0sCJs7FXH1Q1XEiCuMrV_ckVg9tcMvozYThFJfqpcOPdlo6YqxBYf6I1zHO0-yQZ_vz3knSS/pub?gid=1233383270&single=true&output=csv';
    alert("Sheet URL loaded"); // Step 2

    const map = L.map('map').setView([15.8,120.6],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OSM'}).addTo(map);
    alert("Map initialized"); // Step 3

    fetch(sheetURL)
      .then(res => {
        alert("Fetch response received: " + res.status); // Step 4
        return res.text();
      })
      .then(csv => {
        alert("CSV text length: " + csv.length); // Step 5

        const lines = csv.trim().split('\n');
        alert("Line count: " + lines.length); // Step 6

        const header = lines.shift().split(',');
        const rnIdx = header.map(h=>h.trim().toUpperCase()).indexOf('ROUTE NAME');
        const gpIdx = header.map(h=>h.trim().toUpperCase()).indexOf('GEO PATH');
        alert(`Found ROUTE NAME at index ${rnIdx}, GEO PATH at ${gpIdx}`); // Step 7

        let validCount = 0;

        lines.forEach((line,i) => {
          const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
          const geo = cols[gpIdx]?.trim();

          if (geo && geo.startsWith('[[')) {
            validCount++;
          }
        });

        alert("Valid GEO PATH rows: " + validCount); // Step 8

        if(validCount === 0) alert("No valid geo paths found.");
      })
      .catch(err => {
        alert("Fetch error: " + err);
        console.error(err);
      });
  </script>
</body></html>
