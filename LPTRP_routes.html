<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>LPTRP Routes Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; padding: 0; }
    #map { width: 2000px; height: 700px; }
    .search-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      max-width: 350px;
      font-family: Arial, sans-serif;
      z-index: 1000;
    }
    .search-panel h4 {
      margin: 8px 0 4px;
      font-size: 14px;
      font-weight: bold;
    }
    .search-panel input {
      width: 100%;
      padding: 5px;
      margin-bottom: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .suggest-list { position: relative; }
    .suggest-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      max-height: 150px;
      overflow-y: auto;
      display: none;
      z-index: 2000;
    }
    .suggest-dropdown div {
      padding: 5px;
      cursor: pointer;
    }
    .suggest-dropdown div:hover {
      background: #f0f0f0;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="search-panel">
    <h4>Search by Route Name</h4>
    <div class="suggest-list">
      <input id="routeInput" type="text" placeholder="Type route name..." />
      <div id="s_routeInput" class="suggest-dropdown"></div>
    </div>

    <h4>Search by Endpoints</h4>

    <strong>Endpoint 1</strong>
    <div class="suggest-list"><input id="ep1_region" placeholder="Select Region" /><div id="s_ep1_region" class="suggest-dropdown"></div></div>
    <div class="suggest-list"><input id="ep1_province" placeholder="Select Province" /><div id="s_ep1_province" class="suggest-dropdown"></div></div>
    <div class="suggest-list"><input id="ep1_lgu" placeholder="Select LGU" /><div id="s_ep1_lgu" class="suggest-dropdown"></div></div>
    <div class="suggest-list"><input id="ep1_barangay" placeholder="Select Barangay" /><div id="s_ep1_barangay" class="suggest-dropdown"></div></div>
    <div class="suggest-list"><input id="ep1_terminal" placeholder="Select Terminal" /><div id="s_ep1_terminal" class="suggest-dropdown"></div></div>

    <strong>Endpoint 2</strong>
    <div class="suggest-list"><input id="ep2_region" placeholder="Select Region" /><div id="s_ep2_region" class="suggest-dropdown"></div></div>
    <div class="suggest-list"><input id="ep2_province" placeholder="Select Province" /><div id="s_ep2_province" class="suggest-dropdown"></div></div>
    <div class="suggest-list"><input id="ep2_lgu" placeholder="Select LGU" /><div id="s_ep2_lgu" class="suggest-dropdown"></div></div>
    <div class="suggest-list"><input id="ep2_barangay" placeholder="Select Barangay" /><div id="s_ep2_barangay" class="suggest-dropdown"></div></div>
    <div class="suggest-list"><input id="ep2_terminal" placeholder="Select Terminal" /><div id="s_ep2_terminal" class="suggest-dropdown"></div></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
  <script>
    const map = L.map('map').setView([12.8797, 121.7740], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    let allRoutes = [];
    let routeLayers = [];

    function makeSuggestBox(inputEl, dropdownEl, list) {
      inputEl.addEventListener('input', function() {
        const val = this.value.toLowerCase();
        dropdownEl.innerHTML = '';
        if (!val) { dropdownEl.style.display = 'none'; return; }
        const matches = list.filter(item => item && item.toLowerCase().includes(val)).slice(0, 20);
        matches.forEach(match => {
          const div = document.createElement('div');
          div.textContent = match;
          div.onclick = () => {
            inputEl.value = match;
            dropdownEl.style.display = 'none';
            filterRoutes();
          };
          dropdownEl.appendChild(div);
        });
        dropdownEl.style.display = matches.length ? 'block' : 'none';
      });
      document.addEventListener('click', function(e) {
        if (!inputEl.contains(e.target) && !dropdownEl.contains(e.target)) {
          dropdownEl.style.display = 'none';
        }
      });
    }

    function filterRoutes() {
      const routeVal = document.getElementById('routeInput').value.trim().toLowerCase();
      const ep1 = {
        region: document.getElementById('ep1_region').value.trim().toLowerCase(),
        province: document.getElementById('ep1_province').value.trim().toLowerCase(),
        lgu: document.getElementById('ep1_lgu').value.trim().toLowerCase(),
        barangay: document.getElementById('ep1_barangay').value.trim().toLowerCase(),
        terminal: document.getElementById('ep1_terminal').value.trim().toLowerCase()
      };
      const ep2 = {
        region: document.getElementById('ep2_region').value.trim().toLowerCase(),
        province: document.getElementById('ep2_province').value.trim().toLowerCase(),
        lgu: document.getElementById('ep2_lgu').value.trim().toLowerCase(),
        barangay: document.getElementById('ep2_barangay').value.trim().toLowerCase(),
        terminal: document.getElementById('ep2_terminal').value.trim().toLowerCase()
      };

      routeLayers.forEach(layer => map.removeLayer(layer));
      routeLayers = [];

      allRoutes.forEach(r => {
        let show = true;
        if (routeVal && !r['ROUTE NAME'].toLowerCase().includes(routeVal)) show = false;

        if (ep1.region && r['ENDPOINT 1 REGION'].toLowerCase() !== ep1.region) show = false;
        if (ep1.province && r['ENDPOINT 1 PROVINCE'].toLowerCase() !== ep1.province) show = false;
        if (ep1.lgu && r['ENDPOINT 1 LGU'].toLowerCase() !== ep1.lgu) show = false;
        if (ep1.barangay && r['ENDPOINT 1 BARANGAY'].toLowerCase() !== ep1.barangay) show = false;
        if (ep1.terminal && r['ENDPOINT 1 TERMINAL'].toLowerCase() !== ep1.terminal) show = false;

        if (ep2.region && r['ENDPOINT 2 REGION'].toLowerCase() !== ep2.region) show = false;
        if (ep2.province && r['ENDPOINT 2 PROVINCE'].toLowerCase() !== ep2.province) show = false;
        if (ep2.lgu && r['ENDPOINT 2 LGU'].toLowerCase() !== ep2.lgu) show = false;
        if (ep2.barangay && r['ENDPOINT 2 BARANGAY'].toLowerCase() !== ep2.barangay) show = false;
        if (ep2.terminal && r['ENDPOINT 2 TERMINAL'].toLowerCase() !== ep2.terminal) show = false;

        if (show && r['GEO PATH']) {
          try {
            const coords = JSON.parse(r['GEO PATH']);
            const line = L.polyline(coords.map(c => [c[1], c[0]]), { color: getRandomDarkColor(), weight: 3 });
            line.bindPopup(`<b>${r['ROUTE NAME']}</b><br>
              DENO: ${r['DENO'] || ''}<br>
              CLASS: ${r['Class'] || ''}<br>
              ROUTE CLASS: ${r['ROUTE CLASSIFICATION (if LPTRP)'] || ''}<br>
              NAU: ${r['NO. OF AUTHORIZED UNITS'] || ''}`);
            line.addTo(map);
            routeLayers.push(line);
          } catch (e) {}
        }
      });
    }

    function getRandomDarkColor() {
      const letters = '0123456789ABCDEF';
      let color = '#';
      for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 12)]; // darker range
      }
      return color;
    }

    function loadCsvAndInit() {
      Papa.parse('YOUR_GOOGLE_SHEET_CSV_URL_HERE', {
        download: true,
        header: true,
        complete: function(results) {
          allRoutes = results.data;
          const routeNames = [...new Set(allRoutes.map(r => r['ROUTE NAME']).filter(Boolean))];
          const ep1_region = [...new Set(allRoutes.map(r => r['ENDPOINT 1 REGION']).filter(Boolean))];
          const ep1_province = [...new Set(allRoutes.map(r => r['ENDPOINT 1 PROVINCE']).filter(Boolean))];
          const ep1_lgu = [...new Set(allRoutes.map(r => r['ENDPOINT 1 LGU']).filter(Boolean))];
          const ep1_barangay = [...new Set(allRoutes.map(r => r['ENDPOINT 1 BARANGAY']).filter(Boolean))];
          const ep1_terminal = [...new Set(allRoutes.map(r => r['ENDPOINT 1 TERMINAL']).filter(Boolean))];

          const ep2_region = [...new Set(allRoutes.map(r => r['ENDPOINT 2 REGION']).filter(Boolean))];
          const ep2_province = [...new Set(allRoutes.map(r => r['ENDPOINT 2 PROVINCE']).filter(Boolean))];
          const ep2_lgu = [...new Set(allRoutes.map(r => r['ENDPOINT 2 LGU']).filter(Boolean))];
          const ep2_barangay = [...new Set(allRoutes.map(r => r['ENDPOINT 2 BARANGAY']).filter(Boolean))];
          const ep2_terminal = [...new Set(allRoutes.map(r => r['ENDPOINT 2 TERMINAL']).filter(Boolean))];

          makeSuggestBox(document.getElementById('routeInput'), document.getElementById('s_routeInput'), routeNames);
          makeSuggestBox(document.getElementById('ep1_region'), document.getElementById('s_ep1_region'), ep1_region);
          makeSuggestBox(document.getElementById('ep1_province'), document.getElementById('s_ep1_province'), ep1_province);
          makeSuggestBox(document.getElementById('ep1_lgu'), document.getElementById('s_ep1_lgu'), ep1_lgu);
          makeSuggestBox(document.getElementById('ep1_barangay'), document.getElementById('s_ep1_barangay'), ep1_barangay);
          makeSuggestBox(document.getElementById('ep1_terminal'), document.getElementById('s_ep1_terminal'), ep1_terminal);

          makeSuggestBox(document.getElementById('ep2_region'), document.getElementById('s_ep2_region'), ep2_region);
          makeSuggestBox(document.getElementById('ep2_province'), document.getElementById('s_ep2_province'), ep2_province);
          makeSuggestBox(document.getElementById('ep2_lgu'), document.getElementById('s_ep2_lgu'), ep2_lgu);
          makeSuggestBox(document.getElementById('ep2_barangay'), document.getElementById('s_ep2_barangay'), ep2_barangay);
          makeSuggestBox(document.getElementById('ep2_terminal'), document.getElementById('s_ep2_terminal'), ep2_terminal);
        }
      });
    }

    loadCsvAndInit();
  </script>
</body>
</html>
