<!DOCTYPE html>
<html>
<head>
  <title>LTFRB Route Map Viewer</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { width: 100%; height: 90vh; }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      z-index: 1000;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    #controls input, #controls select {
      width: 200px;
      margin: 5px 0;
    }
  </style>
</head>
<body>

<div id="controls">
  <input type="text" id="routeSearch" placeholder="Search Route Name" />
  <input type="text" id="lguSearch" placeholder="Search LGU" />
</div>

<div id="map"></div>

<script>
  const sheetUrl = 'https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/gviz/tq?tqx=out:csv&sheet=MASTERLIST';
  const map = L.map('map').setView([12.8797, 121.7740], 6); // Philippines center

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  L.control.scale().addTo(map);

  const routes = [];
  let routeLayers = [];

  function getRandomColor() {
    return '#' + Math.floor(Math.random()*16777215).toString(16);
  }

  function renderRoutes(filteredRoutes) {
    // Clear existing routes
    routeLayers.forEach(layer => map.removeLayer(layer));
    routeLayers = [];

    filteredRoutes.forEach(({ path, info }) => {
      const polyline = L.polyline(path, {
        color: getRandomColor(),
        weight: 3,
        opacity: 0.7
      }).bindPopup(`<b>Route Name:</b> ${info.routeName}<br><b>LGU:</b> ${info.lgu}`)
        .addTo(map);
      routeLayers.push(polyline);
    });
  }

  fetch(sheetUrl)
    .then(res => res.text())
    .then(csv => {
      const rows = csv.trim().split('\n').map(r => r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/));
      const headers = rows[1]; // Assuming headers on row 2
      const data = rows.slice(2); // skip first two rows

      const routeNameIdx = headers.findIndex(h => h.trim().toLowerCase() === 'route name');
      const lguIdx = headers.findIndex(h => h.trim().toLowerCase() === 'lgu');
      const geoPathIdx = 25; // GEO PATH column index (Z)

      data.forEach(row => {
        const geoPathRaw = row[geoPathIdx];
        if (!geoPathRaw || geoPathRaw.trim() === '') return;

        try {
          const cleaned = geoPathRaw.replace(/^"|"$/g, '').replace(/""/g, '"');
          const path = JSON.parse(cleaned);

          if (Array.isArray(path)) {
            routes.push({
              path,
              info: {
                routeName: row[routeNameIdx]?.trim() || '',
                lgu: row[lguIdx]?.trim() || ''
              }
            });
          }
        } catch (e) {
          console.warn('Invalid GEO PATH:', geoPathRaw);
        }
      });

      renderRoutes(routes);
    });

  function filterRoutes() {
    const routeSearch = document.getElementById('routeSearch').value.toLowerCase();
    const lguSearch = document.getElementById('lguSearch').value.toLowerCase();

    const filtered = routes.filter(({ info }) => {
      return (
        info.routeName.toLowerCase().includes(routeSearch) &&
        info.lgu.toLowerCase().includes(lguSearch)
      );
    });

    renderRoutes(filtered);
  }

  document.getElementById('routeSearch').addEventListener('input', filterRoutes);
  document.getElementById('lguSearch').addEventListener('input', filterRoutes);
</script>

</body>
</html>
