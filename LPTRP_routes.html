<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>LTFRB Routes Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { margin:0; padding:0; }
    #map { width:1170px; height:800px; }
    .search-container {
      position:absolute; top:10px; left:10px;
      background:white; padding:10px;
      border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.2);
      z-index:1000; width:280px;
      font-family: Arial, sans-serif;
    }
    .search-container h4 {
      margin:6px 0; font-size:14px; border-bottom:1px solid #ccc;
    }
    .search-container select, .search-container input {
      width:100%; margin:4px 0; padding:4px;
      font-size:12px;
    }
    .route-list {
      max-height:120px; overflow-y:auto; margin-top:6px;
      border:1px solid #ddd; padding:4px; display:none;
    }
    .route-list div {
      cursor:pointer; padding:2px 4px;
    }
    .route-list div:hover {
      background:#f0f0f0;
    }
  </style>
</head>
<body>
<div id="map"></div>
<div class="search-container">
  <h4>Search by Route Name</h4>
  <input type="text" id="routeSearch" placeholder="Type route name...">
  <h4>Search by Endpoints</h4>
  <select id="pointA"><option value="">--Point A--</option></select>
  <select id="pointB"><option value="">--Point B (Optional)--</option></select>
  <select id="via"><option value="">--Via (Optional)--</option></select>
  <div id="routeList" class="route-list"></div>
</div>

<script>
const sheetUrl = "https://docs.google.com/spreadsheets/d/1CyoUxFDCCgDArR1iTMZJG02RTke8QoTzL7HhHwcwk6k/gviz/tq?tqx=out:csv&sheet=MASTERLIST";

let map = L.map('map').setView([12.8797, 121.7740], 6);

// basemap
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

let routesLayer = L.layerGroup().addTo(map);
let allRoutes = [];

// Parse CSV
Papa.parse(sheetUrl, {
  download: true,
  header: true,
  complete: function(results) {
    results.data.forEach(row => {
      if (!row["GEO PATH"]) return;
      try {
        let coords = JSON.parse(row["GEO PATH"]);
        if (!Array.isArray(coords)) return;

        let latlngs = coords.map(c => [c[1], c[0]]);
        let color = getRandomColor();

        let polyline = L.polyline(latlngs, {color:color, weight:3}).addTo(routesLayer);

        // Popup content
        let popupContent = `
          <b>ROUTE NAME:</b> ${row["ROUTE NAME"] || "N/A"}<br>
          <b>DENO:</b> ${row["DENO"] || "N/A"}<br>
          <b>CLASS:</b> ${row["Class"] || "N/A"}<br>
          <b>CLASSIFICATION:</b> ${row["ROUTE CLASSIFICATION (if LPTRP)"] || "N/A"}<br>
          <b>NAU:</b> ${row["NO. OF AUTHORIZED UNITS"] || "N/A"}
        `;

        // Offset popup so it wonâ€™t cover route line
        polyline.bindPopup(popupContent, { offset: L.point(0,-15) });

        // Hover highlight
        polyline.on('mouseover', function(e){
          this.setStyle({weight:6});
          let count = getRoutesAtPoint(e.latlng).length;
          this.bindTooltip(count+" route(s) here",{sticky:true}).openTooltip();
        });
        polyline.on('mouseout', function(){
          this.setStyle({weight:3});
          this.closeTooltip();
        });

        // Click to list overlapping routes
        polyline.on('click', function(e){
          showRouteList(getRoutesAtPoint(e.latlng), e.latlng);
        });

        allRoutes.push({polyline:polyline, data:row, color:color});
      } catch(err) {
        console.error("Bad GEO PATH:", err);
      }
    });
  }
});

// Helpers
function getRandomColor(){
  return '#'+Math.floor(Math.random()*16777215).toString(16);
}

function getRoutesAtPoint(latlng){
  let found = [];
  allRoutes.forEach(r=>{
    if (r.polyline.getBounds().contains(latlng)) {
      found.push(r);
    }
  });
  return found;
}

function showRouteList(routes, latlng){
  let container = document.getElementById("routeList");
  container.innerHTML = "";
  if(routes.length===0){ container.style.display="none"; return; }
  routes.forEach(r=>{
    let div = document.createElement("div");
    div.textContent = r.data["ROUTE NAME"] || "Unnamed Route";
    div.onclick = function(){
      map.fitBounds(r.polyline.getBounds());
      r.polyline.openPopup();
    };
    container.appendChild(div);
  });
  container.style.display="block";
}
</script>
</body>
</html>
