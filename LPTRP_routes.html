<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>LTFRB Routes Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link 
    rel="stylesheet" 
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
    integrity="sha256-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC0=" 
    crossorigin=""
  />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script 
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
    integrity="sha256-o9N1jGDZrf5tS+eodcU6iJt0QJU1gCQPnMmIDdDCh+o=" 
    crossorigin="">
  </script>
  <script>
    const MAP = L.map('map').setView([12.8797, 121.774], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(MAP);

    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRyCBsc0sCJs7FXH1Q1XEiCuMrV_ckVg9tcMvozYThFJfqpcOPdlo6YqxBYf6I1zHO0-yQZ_vz3knSS/pub?gid=1233383270&single=true&output=csv";

    async function loadRoutes() {
      try {
        const res = await fetch(CSV_URL);
        if (!res.ok) throw new Error("CSV fetch failed");
        const csvText = await res.text();
        parseCSV(csvText);
      } catch (e) {
        console.error("‚ùå Failed to load CSV:", e);
      }
    }

    function parseCSV(text) {
      const rows = text.trim().split("\n").slice(1); // skip header row (row 2)
      const headers = text.trim().split("\n")[0].split(",");
      const geoPathIndex = headers.indexOf("GEO PATH");

      if (geoPathIndex === -1) {
        console.error("‚ùå 'GEO PATH' column not found in CSV.");
        return;
      }

      let valid = 0, empty = 0, invalid = 0;

      rows.forEach((row, index) => {
        const cols = row.split(",");
        const path = cols[geoPathIndex]?.trim();

        if (!path) {
          console.warn(`‚ö†Ô∏è GEO PATH is empty at row ${index + 3}`);
          empty++;
          return;
        }

        // Debug: Log the raw path string
        console.log(`üîç Raw GEO PATH at row ${index + 3}:`, path);

        try {
          const coords = JSON.parse(path);
          if (!Array.isArray(coords)) throw new Error("Not an array");

          L.polyline(coords.map(([lng, lat]) => [lat, lng]), {
            color: 'blue',
            weight: 3
          }).addTo(MAP);

          valid++;
        } catch (e) {
          console.warn(`‚ö†Ô∏è Invalid GEO PATH at row ${index + 3}`, e);
          invalid++;
        }
      });

      console.log(`üìä Rows processed: ${rows.length}`);
      console.log(`üü¢ Valid geo paths: ${valid}`);
      console.log(`‚ö†Ô∏è Skipped empty GEO PATH rows: ${empty}`);
      console.log(`‚ö†Ô∏è Skipped invalid GEO PATH rows: ${invalid}`);

      if (valid === 0) {
        console.log("üö´ No valid routes found.");
      }
    }

    loadRoutes();
  </script>
</body>
</html>
