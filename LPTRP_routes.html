<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Route Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { margin:0; padding:0; }
    #map { width: 100%; height: 100vh; }
    .info-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      padding: 10px;
      max-height: 90vh;
      overflow-y: auto;
      font-family: Arial, sans-serif;
      display: none;
      width: 320px;
    }
    .info-header { font-weight: bold; margin-bottom: 5px; }
    .route-item { cursor: pointer; padding: 4px; border-bottom: 1px solid #ddd; }
    .route-item:hover { background: #f0f0f0; }
    .route-list, .route-details {
      display: inline-block;
      vertical-align: top;
      width: 48%;
    }
    .route-list { border-right: 1px solid #ccc; margin-right: 2%; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="infoPanel" class="info-panel">
    <div class="info-header">Routes</div>
    <div style="display:flex; gap:5px;">
      <div class="route-list" id="routeList"></div>
      <div class="route-details" id="routeDetails"></div>
    </div>
  </div>
  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRyCBsc0sCJs7FXH1Q1XEiCuMrV_ckVg9tcMvozYThFJfqpcOPdlo6YqxBYf6I1zHO0-yQZ_vz3knSS/pub?gid=1233383270&single=true&output=csv";

    const map = L.map('map').setView([12.8797, 121.7740], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    let routes = [];

    // Parse CSV and draw routes
    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: function(results) {
        results.data.forEach(row => {
          if (row["GEO PATH"]) {
            try {
              let coords = JSON.parse(row["GEO PATH"]);
              let polyline = L.polyline(coords, {
                color: getRandomColor(),
                weight: 3
              }).addTo(map);
              polyline.featureData = {
                "Route Name": row["ROUTE NAME"],
                "DENO": row["DENO"],
                "Class": row["Class"],
                "Route Class": row["ROUTE CLASSIFICATION (if LPTRP)"],
                "NAU": row["NO. OF AUTHORIZED UNITS"]
              };
              routes.push(polyline);
            } catch (e) {
              console.error("Bad GEO PATH:", row["GEO PATH"]);
            }
          }
        });
      }
    });

    // Hover: show number of overlapping routes
    map.on('mousemove', function(e) {
      let overlaps = routes.filter(r => leafletPip.pointInLayer([e.latlng.lng, e.latlng.lat], r).length > 0);
      if (overlaps.length > 0) {
        map.getContainer().style.cursor = 'pointer';
      } else {
        map.getContainer().style.cursor = '';
      }
    });

    // Click: show list
    map.on('click', function(e) {
      let clickedRoutes = routes.filter(r => r.getBounds().contains(e.latlng));
      const panel = document.getElementById("infoPanel");
      const listDiv = document.getElementById("routeList");
      const detailsDiv = document.getElementById("routeDetails");

      if (clickedRoutes.length > 0) {
        panel.style.display = "block";
        listDiv.innerHTML = "";
        detailsDiv.innerHTML = "";
        clickedRoutes.forEach((r, i) => {
          let div = document.createElement("div");
          div.className = "route-item";
          div.innerText = r.featureData["Route Name"];
          div.onclick = () => {
            detailsDiv.innerHTML = `
              <b>Route Name:</b> ${r.featureData["Route Name"]}<br/>
              <b>DENO:</b> ${r.featureData["DENO"]}<br/>
              <b>Class:</b> ${r.featureData["Class"]}<br/>
              <b>Route Class:</b> ${r.featureData["Route Class"]}<br/>
              <b>NAU:</b> ${r.featureData["NAU"]}
            `;
            r.setStyle({weight: 5});
          };
          listDiv.appendChild(div);
        });
      } else {
        panel.style.display = "none";
      }
    });

    function getRandomColor() {
      return '#' + Math.floor(Math.random()*16777215).toString(16);
    }
  </script>
</body>
</html>
