<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>LPTRP Route Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Awesomplete for suggestions -->
<link rel="stylesheet" href="https://leaverou.github.io/awesomplete/awesomplete.css" />
<script src="https://leaverou.github.io/awesomplete/awesomplete.min.js"></script>

<style>
  body { margin:0; padding:0; }
  #map { width: 2000px; height: 700px; }

  .search-panel {
    position: absolute;
    top: 10px;
    left: 10px;
    background: white;
    padding: 10px;
    z-index: 1000;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    max-height: 90%;
    overflow-y: auto;
    font-family: Arial, sans-serif;
    font-size: 13px;
  }

  .search-panel h3 {
    margin: 8px 0 4px;
    font-size: 14px;
  }

  .search-panel input {
    width: 250px;
    margin-bottom: 6px;
    padding: 5px;
  }
</style>
</head>
<body>

<div id="map"></div>

<div class="search-panel">
  <h3>Search by Route Name</h3>
  <input id="routeNameInput" placeholder="Select Route" class="awesomplete" data-multiple />

  <h3>Search by Endpoints</h3>

  <strong>Endpoint 1</strong><br>
  <input id="ep1Region" placeholder="Select Region">
  <input id="ep1Province" placeholder="Select Province">
  <input id="ep1LGU" placeholder="Select LGU">
  <input id="ep1Barangay" placeholder="Select Barangay">
  <input id="ep1Terminal" placeholder="Select Terminal">

  <br><strong>Endpoint 2</strong><br>
  <input id="ep2Region" placeholder="Select Region">
  <input id="ep2Province" placeholder="Select Province">
  <input id="ep2LGU" placeholder="Select LGU">
  <input id="ep2Barangay" placeholder="Select Barangay">
  <input id="ep2Terminal" placeholder="Select Terminal">
</div>

<script>
const sheetUrl = 'YOUR_PUBLISHED_CSV_URL_HERE'; // replace with your published CSV link

let map = L.map('map').setView([12.8797, 121.7740], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

let allData = [];
let routeLayers = [];

// Dark color palette
function getRandomDarkColor() {
  const colors = ['#1b1b1b','#2b2b2b','#003366','#004c4c','#660000','#663300','#4d004d','#003300','#1a1a1a','#0d0d0d','#333333','#222222'];
  return colors[Math.floor(Math.random()*colors.length)];
}

// Load CSV
fetch(sheetUrl)
  .then(res => res.text())
  .then(csv => {
    const rows = csv.split('\n').map(r => r.split(','));
    const headers = rows.shift();
    allData = rows.map(row => {
      let obj = {};
      headers.forEach((h, i) => obj[h.trim()] = row[i] ? row[i].trim() : '');
      return obj;
    });
    initSuggestions();
    drawRoutes();
  });

// Populate suggestions
function initSuggestions() {
  const setAwesomplete = (id, values) => {
    new Awesomplete(document.getElementById(id), { list: [...new Set(values.filter(v => v))] });
  };

  setAwesomplete('routeNameInput', allData.map(d => d['ROUTE NAME']));
  setAwesomplete('ep1Region', allData.map(d => d['ENDPOINT 1 REGION']));
  setAwesomplete('ep1Province', allData.map(d => d['ENDPOINT 1 PROVINCE']));
  setAwesomplete('ep1LGU', allData.map(d => d['ENDPOINT 1 LGU']));
  setAwesomplete('ep1Barangay', allData.map(d => d['ENDPOINT 1 BARANGAY']));
  setAwesomplete('ep1Terminal', allData.map(d => d['ENDPOINT 1 TERMINAL']));

  setAwesomplete('ep2Region', allData.map(d => d['ENDPOINT 2 REGION']));
  setAwesomplete('ep2Province', allData.map(d => d['ENDPOINT 2 PROVINCE']));
  setAwesomplete('ep2LGU', allData.map(d => d['ENDPOINT 2 LGU']));
  setAwesomplete('ep2Barangay', allData.map(d => d['ENDPOINT 2 BARANGAY']));
  setAwesomplete('ep2Terminal', allData.map(d => d['ENDPOINT 2 TERMINAL']));
}

// Draw routes with filtering
function drawRoutes() {
  routeLayers.forEach(l => map.removeLayer(l));
  routeLayers = [];

  const routeFilter = document.getElementById('routeNameInput').value.split(',').map(s => s.trim()).filter(s => s);
  const ep1R = document.getElementById('ep1Region').value.trim();
  const ep1P = document.getElementById('ep1Province').value.trim();
  const ep1L = document.getElementById('ep1LGU').value.trim();
  const ep1B = document.getElementById('ep1Barangay').value.trim();
  const ep1T = document.getElementById('ep1Terminal').value.trim();

  const ep2R = document.getElementById('ep2Region').value.trim();
  const ep2P = document.getElementById('ep2Province').value.trim();
  const ep2L = document.getElementById('ep2LGU').value.trim();
  const ep2B = document.getElementById('ep2Barangay').value.trim();
  const ep2T = document.getElementById('ep2Terminal').value.trim();

  allData.forEach(row => {
    if (routeFilter.length && !routeFilter.includes(row['ROUTE NAME'])) return;
    if (ep1R && row['ENDPOINT 1 REGION'] !== ep1R) return;
    if (ep1P && row['ENDPOINT 1 PROVINCE'] !== ep1P) return;
    if (ep1L && row['ENDPOINT 1 LGU'] !== ep1L) return;
    if (ep1B && row['ENDPOINT 1 BARANGAY'] !== ep1B) return;
    if (ep1T && row['ENDPOINT 1 TERMINAL'] !== ep1T) return;

    if (ep2R && row['ENDPOINT 2 REGION'] !== ep2R) return;
    if (ep2P && row['ENDPOINT 2 PROVINCE'] !== ep2P) return;
    if (ep2L && row['ENDPOINT 2 LGU'] !== ep2L) return;
    if (ep2B && row['ENDPOINT 2 BARANGAY'] !== ep2B) return;
    if (ep2T && row['ENDPOINT 2 TERMINAL'] !== ep2T) return;

    let path;
    try {
      path = JSON.parse(row['GEO PATH']);
    } catch (e) {
      return;
    }

    if (Array.isArray(path)) {
      let layer = L.polyline(path.map(p => [p[1], p[0]]), {
        color: getRandomDarkColor(),
        weight: 3
      }).bindPopup(`
        <b style="font-size:16px">${row['ROUTE NAME']}</b><br>
        DENO: ${row['DENO'] || ''}<br>
        CLASS: ${row['Class'] || ''}<br>
        ROUTE CLASS: ${row['ROUTE CLASSIFICATION (if LPTRP)'] || ''}<br>
        NAU: ${row['NO. OF AUTHORIZED UNITS'] || ''}
      `);
      layer.addTo(map);
      routeLayers.push(layer);
    }
  });
}

// Event listeners
document.querySelectorAll('.search-panel input').forEach(inp => {
  inp.addEventListener('change', drawRoutes);
});
</script>
</body>
</html>
