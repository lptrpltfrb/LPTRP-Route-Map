<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>LTFRB Routes Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://leaverou.github.io/awesomplete/awesomplete.css" />
  <style>
    #map { width: 1170px; height: 800px; }
    .filter-container {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 300px;
    }
    .filter-container h4 { margin: 5px 0; font-size: 14px; }
    .filter-box {
      width: 100%;
      padding: 5px;
      margin: 3px 0 8px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .awesomplete { width: 100%; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="filter-container">
    <h4>Search by Route Name</h4>
    <input id="routeNameFilter" class="filter-box" placeholder="Type route name..." />

    <h4>Search by Endpoints</h4>
    <input id="endpoint1Filter" class="filter-box" placeholder="Endpoint 1 (Region, Province, LGU, Barangay, Terminal)" />
    <input id="endpoint2Filter" class="filter-box" placeholder="Endpoint 2 (Region, Province, LGU, Barangay, Terminal)" />
    <input id="viaFilter" class="filter-box" placeholder="Via (Route Structure or Corridor)" />
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://leaverou.github.io/awesomplete/awesomplete.min.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const map = L.map('map').setView([12.8797, 121.7740], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const routeLayerGroup = L.layerGroup().addTo(map);
    const terminalLayerGroup = L.layerGroup().addTo(map);

    const routeNameFilter = document.getElementById('routeNameFilter');
    const endpoint1Filter = document.getElementById('endpoint1Filter');
    const endpoint2Filter = document.getElementById('endpoint2Filter');
    const viaFilter = document.getElementById('viaFilter');

    let allData = [];
    let allTerminals = [];
    let routeLayers = [];
    let terminalMarkers = [];

    // === LOAD MASTERLIST ===
    Papa.parse("YOUR_MASTERLIST_CSV_URL_HERE", {
      download: true,
      header: true,
      complete: function(results) {
        allData = results.data.filter(row => row["ROUTE NAME"]);
        drawRoutes(allData);
        setupFilters(allData);
      }
    });

    // === LOAD TERMINALS ===
    Papa.parse("YOUR_TERMINAL_CSV_URL_HERE", {
      download: true,
      header: true,
      complete: function(results) {
        allTerminals = results.data.filter(row => row["Terminal Name"]);
        drawTerminals(allTerminals);
      }
    });

    function drawRoutes(data) {
      routeLayerGroup.clearLayers();
      routeLayers = [];

      data.forEach(row => {
        if (row["GEO PATH"]) {
          try {
            const coords = JSON.parse(row["GEO PATH"]);
            const polyline = L.polyline(coords, {
              color: getRandomColor(),
              weight: 2,   // thinner lines
              opacity: 0.8
            });

            polyline.bindPopup(`
              <b>${row["ROUTE NAME"] || ""}</b><br>
              DENO: ${row["DENO"] || ""}<br>
              Class: ${row["Class"] || ""}<br>
              Classification: ${row["ROUTE CLASSIFICATION (if LPTRP)"] || ""}<br>
              NAU: ${row["NO. OF AUTHORIZED UNITS"] || ""}
            `);

            polyline.on("click", () => {
              routeLayerGroup.eachLayer(l => l.setStyle({ weight: 2, opacity: 0.5 }));
              polyline.setStyle({ weight: 5, opacity: 1 });
              map.fitBounds(polyline.getBounds(), { padding: [50, 50] }); // move to top
            });

            polyline.addTo(routeLayerGroup);
            routeLayers.push({ layer: polyline, data: row });
          } catch (e) {
            console.error("Invalid GEO PATH", e);
          }
        }
      });
    }

    function drawTerminals(data) {
      terminalLayerGroup.clearLayers();
      terminalMarkers = [];

      data.forEach(row => {
        if (row["Latitude"] && row["Longitude"]) {
          const marker = L.marker([+row["Latitude"], +row["Longitude"]]);

          let terminalType = row["Terminal Type"] ? ` (${row["Terminal Type"]})` : "";
          marker.bindPopup(`
            <b>${row["Terminal Name"] || ""}</b><br>
            ${row["Address"] || ""}<br>
            ${terminalType}
          `);

          marker.addTo(terminalLayerGroup);
          terminalMarkers.push({ marker, data: row });
        }
      });
    }

    function setupFilters(data) {
      const routeNames = [...new Set(data.map(r => r["ROUTE NAME"]).filter(Boolean))];
      const endpoints1 = [
        ...new Set(data.flatMap(r => [
          r["ENDPOINT 1 REGION"], r["ENDPOINT 1 PROVINCE"], r["ENDPOINT 1 LGU"], r["ENDPOINT 1 BARANGAY"], r["ENDPOINT 1 TERMINAL"]
        ]).filter(Boolean))
      ];
      const endpoints2 = [
        ...new Set(data.flatMap(r => [
          r["ENDPOINT 2 REGION"], r["ENDPOINT 2 PROVINCE"], r["ENDPOINT 2 LGU"], r["ENDPOINT 2 BARANGAY"], r["ENDPOINT 2 TERMINAL"]
        ]).filter(Boolean))
      ];
      const vias = [
        ...new Set(data.flatMap(r => [r["ROUTE STRUCTURE"], r["CORRIDOR"]]).filter(Boolean))
      ];

      const filters = [
        { input: routeNameFilter, list: routeNames },
        { input: endpoint1Filter, list: endpoints1 },
        { input: endpoint2Filter, list: endpoints2 },
        { input: viaFilter, list: vias }
      ];

      filters.forEach(f => {
        const awesomplete = new Awesomplete(f.input, {
          list: f.list,
          minChars: 1,
          autoFirst: true
        });

        // âœ… Fix: selecting suggestion applies filters immediately
        f.input.addEventListener("awesomplete-selectcomplete", () => {
          applyFilters();
        });

        // Also trigger filtering when manually typed
        f.input.addEventListener("change", applyFilters);
      });
    }

    function applyFilters() {
      const routeVal = routeNameFilter.value.trim().toLowerCase();
      const ep1Val = endpoint1Filter.value.trim().toLowerCase();
      const ep2Val = endpoint2Filter.value.trim().toLowerCase();
      const viaVal = viaFilter.value.trim().toLowerCase();

      routeLayers.forEach(({ layer, data }) => {
        let match = true;

        if (routeVal && data["ROUTE NAME"]?.toLowerCase() !== routeVal) match = false;

        if (ep1Val && !Object.values(data).some(v => v && v.toLowerCase() === ep1Val)) match = false;
        if (ep2Val && !Object.values(data).some(v => v && v.toLowerCase() === ep2Val)) match = false;

        if (viaVal && !(data["ROUTE STRUCTURE"]?.toLowerCase() === viaVal || data["CORRIDOR"]?.toLowerCase() === viaVal)) match = false;

        if (match) {
          routeLayerGroup.addLayer(layer);
        } else {
          routeLayerGroup.removeLayer(layer);
        }
      });

      terminalMarkers.forEach(({ marker, data }) => {
        let match = true;
        if (ep1Val && data["Terminal Name"]?.toLowerCase() !== ep1Val) match = false;
        if (ep2Val && data["Terminal Name"]?.toLowerCase() !== ep2Val) match = false;

        if (match) {
          terminalLayerGroup.addLayer(marker);
        } else {
          terminalLayerGroup.removeLayer(marker);
        }
      });
    }

    function getRandomColor() {
      return "#" + Math.floor(Math.random() * 16777215).toString(16);
    }
  </script>
</body>
</html>
