<!DOCTYPE html>
<html>
<head>
  <title>LPTRP Route Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; }
    #map { height: 800px; width: 1170px; margin: auto; }
    .search-container {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 1000;
      width: 300px;
    }
    .search-container h4 {
      margin: 5px 0;
    }
    .search-container select, .search-container input {
      width: 100%;
      padding: 6px;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
<div id="map"></div>

<div class="search-container">
  <div>
    <h4>Search by Route Name</h4>
    <input type="text" id="routeSearch" placeholder="Type route name...">
  </div>
  <div>
    <h4>Search by Endpoints</h4>
    <select id="pointA">
      <option>--Choose Point A--</option>
    </select>
    <select id="pointB">
      <option>--If Applicable--</option>
    </select>
    <select id="via">
      <option>--Optional--</option>
    </select>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- PapaParse CSV parser -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<script>
  const map = L.map('map').setView([13, 122], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  L.control.scale().addTo(map);
  const north = L.control({position: "topright"});
  north.onAdd = function () {
    const div = L.DomUtil.create("div", "info legend");
    div.innerHTML = '<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/North_arrow.svg/100px-North_arrow.svg.png" height="50">';
    return div;
  };
  north.addTo(map);

  const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRyCBsc0sCJs7FXH1Q1XEiCuMrV_ckVg9tcMvozYThFJfqpcOPdlo6YqxBYf6I1zHO0-yQZ_vz3knSS/pub?gid=1233383270&single=true&output=csv";
  let allRoutes = [];

  function getRandomColor() {
    return `#${Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')}`;
  }

  function drawRoutes(routes) {
    map.eachLayer(layer => {
      if (layer instanceof L.Polyline && !layer._url) map.removeLayer(layer);
    });

    routes.forEach(route => {
      const segments = Array.isArray(route.geo) && Array.isArray(route.geo[0][0]) ? route.geo : [route.geo];
      segments.forEach(segment => {
        const latlngs = segment.map(coord => [coord[1], coord[0]]);
        L.polyline(latlngs, {
          color: route.color,
          weight: 4
        }).addTo(map)
          .bindPopup(`<b>${route.name}</b><br>NAU: ${route.nau}<br>DENO: ${route.deno}<br>CLASSIFICATION: ${route.classification}`);
      });
    });
  }

  function populateDropdown(id, values) {
    const select = document.getElementById(id);
    values.sort().forEach(val => {
      const opt = document.createElement('option');
      opt.value = val;
      opt.textContent = val;
      select.appendChild(opt);
    });
  }

  function applyFilters() {
    const pointA = document.getElementById('pointA').value.trim().toLowerCase();
    const pointB = document.getElementById('pointB').value.trim().toLowerCase();
    const via = document.getElementById('via').value.trim().toLowerCase();

    const filtered = allRoutes.filter(route => {
      const matchesA = pointA === "--choose point a--" || route.endpoints.some(ep => ep.includes(pointA));
      const matchesB = pointB === "--if applicable--" || route.endpoints.some(ep => ep.includes(pointB));
      const matchesVia = via === "--optional--" || route.via.includes(via);
      return matchesA && matchesB && matchesVia;
    });
    drawRoutes(filtered);
  }

  async function loadRoutes() {
    const res = await fetch(csvUrl);
    const text = await res.text();
    Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const pointSet = new Set(), viaSet = new Set();
        allRoutes = results.data.map(row => {
          let geo = [];
          try { geo = JSON.parse(row["GEO PATH"]); } catch (e) {}

          const points = [
            row["ENDPOINT 1 REGION"], row["ENDPOINT 1 PROVINCE"], row["ENDPOINT 1 LGU"], row["ENDPOINT 1 BARANGAY"], row["ENDPOINT 1 TERMINAL"],
            row["ENDPOINT 2 REGION"], row["ENDPOINT 2 PROVINCE"], row["ENDPOINT 2 LGU"], row["ENDPOINT 2 BARANGAY"], row["ENDPOINT 2 TERMINAL"]
          ].filter(x => x).map(x => x.toLowerCase());

          points.forEach(p => pointSet.add(p));
          if (row["ROUTE STRUCTURE"]) viaSet.add(row["ROUTE STRUCTURE"].toLowerCase());
          if (row["CORRIDOR"]) viaSet.add(row["CORRIDOR"].toLowerCase());

          return {
            name: row["ROUTE NAME"] || "Unnamed",
            nau: row["NO. OF AUTHORIZED UNITS"] || "",
            deno: row["DENO"] || "",
            classification: row["ROUTE CLASSIFICATION (if LPTRP)"] || "",
            geo,
            color: getRandomColor(),
            endpoints: points,
            via: [row["ROUTE STRUCTURE"], row["CORRIDOR"]].filter(x => x).map(x => x.toLowerCase())
          };
        });

        populateDropdown("pointA", [...pointSet]);
        populateDropdown("pointB", [...pointSet]);
        populateDropdown("via", [...viaSet]);
        drawRoutes(allRoutes);
      }
    });
  }

  document.getElementById("routeSearch").addEventListener("input", e => {
    const searchTerm = e.target.value.trim().toLowerCase();
    const matches = allRoutes.filter(r => r.name.toLowerCase().includes(searchTerm));
    drawRoutes(matches);
  });

  document.getElementById("pointA").addEventListener("change", applyFilters);
  document.getElementById("pointB").addEventListener("change", applyFilters);
  document.getElementById("via").addEventListener("change", applyFilters);

  loadRoutes();
</script>
</body>
</html>
